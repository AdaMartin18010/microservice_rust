# 9.4 微服务安全最佳实践

## 9.4.1 身份与访问控制

- 最小权限、零信任、细粒度权限模型（RBAC/ABAC）；
- 统一身份（OIDC）与短期凭证；
- 密钥轮换与审计。

## 9.4.2 输入/输出与序列化

- 严格校验、限制大小与速率；
- 反序列化安全（拒绝深度嵌套、禁用危险类型）；
- 内容安全策略（响应头与网关过滤）。

## 9.4.3 传输与存储

- mTLS、TLS 最佳实践；
- 静态加密（磁盘/数据库字段级）；
- 机密管理与最小暴露面。

## 9.4.4 SPIFFE/SPIRE 与身份供应

- 使用 SPIFFE ID（`spiffe://domain/ns/<ns>/sa/<sa>`）作为工作负载身份；
- 由 SPIRE Server/Agent 签发 SVID（X.509/JWT），Sidecar 或应用内直接加载；
- gRPC/TLS 通过 SPIFFE 验证对端身份，基于 ID 做细粒度授权；
- 与网格/Ingress 集成：统一终端鉴权与mTLS信任根。

### Rust 中加载 SVID（示意）

```rust
// 伪代码：通过 SPIRE Agent Unix Socket 获取 SVID，用于 tonic TLS
use tonic::transport::{ClientTlsConfig, Certificate, Identity};

fn tls_from_svid(svid_cert_pem: &str, svid_key_pem: &str, bundle_pem: &str) -> ClientTlsConfig {
    let identity = Identity::from_pem(svid_cert_pem.as_bytes(), svid_key_pem.as_bytes());
    let ca = Certificate::from_pem(bundle_pem.as_bytes());
    ClientTlsConfig::new().ca_certificate(ca).identity(identity)
}
```

## 9.4.5 证书与密钥轮换

- 短期证书（小时级）+ 自动轮换（SPIRE/Cert-Manager）；
- 零停机：双证书重叠有效期，优雅重启或热更新；
- 秘密管理：K8s Secrets + 加密后端（KMS），最小权限挂载；
- 审计：记录签发、吊销、使用轨迹。

## 9.4.6 端到端加固清单

- 入站：WAF、速率限制、IP/地理策略；
- 应用：输入校验、反序列化白名单、超时与隔离；
- 出站：仅允许必要目标（egress policy），启用 mTLS；
- 数据：加密、脱敏、最小可见域；
- 供应链：SBOM、签名、镜像拉取策略；
- 运行：安全上下文（非 root、只读根文件系统、能力裁剪）。

## 9.4.4 供应链与依赖

- `cargo audit/deny`，SBOM，签名与镜像扫描；
- CI 策略阻断高危依赖；
- 可重现构建与最小基础镜像。
