# ç›‘æ§ä¸å¯è§‚æµ‹æ€§é›†æˆæŒ‡å—

> åŸºäºRust 1.90å’Œæœ€æ–°ä¾èµ–ç‰ˆæœ¬çš„å¾®æœåŠ¡ç›‘æ§ä¸å¯è§‚æµ‹æ€§å®Œæ•´è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„ç›‘æ§ä¸å¯è§‚æµ‹æ€§é›†æˆæ–¹æ¡ˆï¼ŒåŒ…æ‹¬æŒ‡æ ‡æ”¶é›†ã€æ—¥å¿—èšåˆã€åˆ†å¸ƒå¼è¿½è¸ªã€å‘Šè­¦é…ç½®ç­‰å…¨æ ˆç›‘æ§è§£å†³æ–¹æ¡ˆã€‚

## ğŸ¯ ç›‘æ§æ¶æ„

### 1. æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "åº”ç”¨å±‚"
        MS1[å¾®æœåŠ¡1] --> METRICS[æŒ‡æ ‡]
        MS2[å¾®æœåŠ¡2] --> LOGS[æ—¥å¿—]
        MS3[å¾®æœåŠ¡3] --> TRACES[è¿½è¸ª]
    end
    
    subgraph "æ”¶é›†å±‚"
        METRICS --> PROM[Prometheus]
        LOGS --> LOKI[Loki]
        TRACES --> JAEGER[Jaeger]
    end
    
    subgraph "å­˜å‚¨å±‚"
        PROM --> TSDB[æ—¶åºæ•°æ®åº“]
        LOKI --> LOGSTORE[æ—¥å¿—å­˜å‚¨]
        JAEGER --> TRACESTORE[è¿½è¸ªå­˜å‚¨]
    end
    
    subgraph "å¯è§†åŒ–å±‚"
        TSDB --> GRAFANA[Grafana]
        LOGSTORE --> GRAFANA
        TRACESTORE --> GRAFANA
    end
    
    subgraph "å‘Šè­¦å±‚"
        PROM --> ALERT[AlertManager]
        ALERT --> NOTIFY[é€šçŸ¥æ¸ é“]
    end
```

### 2. æŠ€æœ¯æ ˆé€‰æ‹©

| ç»„ä»¶ | æŠ€æœ¯é€‰æ‹© | ç‰ˆæœ¬ | ç”¨é€” |
|------|----------|------|------|
| æŒ‡æ ‡æ”¶é›† | Prometheus | 2.45+ | æŒ‡æ ‡å­˜å‚¨å’ŒæŸ¥è¯¢ |
| æ—¥å¿—èšåˆ | Loki | 2.9+ | æ—¥å¿—æ”¶é›†å’Œå­˜å‚¨ |
| åˆ†å¸ƒå¼è¿½è¸ª | Jaeger | 1.47+ | é“¾è·¯è¿½è¸ª |
| å¯è§†åŒ– | Grafana | 10.0+ | ç»Ÿä¸€ä»ªè¡¨æ¿ |
| å‘Šè­¦ç®¡ç† | AlertManager | 0.25+ | å‘Šè­¦è·¯ç”±å’Œé€šçŸ¥ |
| æŒ‡æ ‡å¯¼å‡º | OpenTelemetry | 0.30+ | æ ‡å‡†åŒ–æŒ‡æ ‡å¯¼å‡º |

## ğŸ“Š æŒ‡æ ‡ç›‘æ§

### 1. åº”ç”¨æŒ‡æ ‡é›†æˆ

#### 1.1 åŸºç¡€æŒ‡æ ‡é…ç½®

```rust
// src/metrics/mod.rs
use prometheus::{
    Counter, Histogram, Gauge, Registry, IntCounter, IntGauge, IntHistogram,
    Opts, HistogramOpts, CounterVec, HistogramVec, GaugeVec,
};
use std::sync::Arc;

pub struct Metrics {
    // HTTPæŒ‡æ ‡
    pub http_requests_total: CounterVec,
    pub http_request_duration: HistogramVec,
    pub http_requests_in_flight: GaugeVec,
    
    // ä¸šåŠ¡æŒ‡æ ‡
    pub user_registrations_total: Counter,
    pub active_users: Gauge,
    pub database_connections: Gauge,
    
    // ç³»ç»ŸæŒ‡æ ‡
    pub memory_usage_bytes: Gauge,
    pub cpu_usage_percent: Gauge,
    
    // è‡ªå®šä¹‰æŒ‡æ ‡
    pub custom_operations_total: CounterVec,
    pub custom_operation_duration: HistogramVec,
}

impl Metrics {
    pub fn new(registry: &Registry) -> Result<Self, prometheus::Error> {
        // HTTPæŒ‡æ ‡
        let http_requests_total = CounterVec::new(
            Opts::new("http_requests_total", "Total number of HTTP requests")
                .namespace("microservice")
                .subsystem("http"),
            &["method", "endpoint", "status_code"],
        )?;
        
        let http_request_duration = HistogramVec::new(
            HistogramOpts::new("http_request_duration_seconds", "HTTP request duration in seconds")
                .namespace("microservice")
                .subsystem("http")
                .buckets(vec![0.001, 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1.0, 2.5, 5.0, 10.0]),
            &["method", "endpoint"],
        )?;
        
        let http_requests_in_flight = GaugeVec::new(
            Opts::new("http_requests_in_flight", "Number of HTTP requests currently being processed")
                .namespace("microservice")
                .subsystem("http"),
            &["method", "endpoint"],
        )?;
        
        // ä¸šåŠ¡æŒ‡æ ‡
        let user_registrations_total = Counter::new(
            "user_registrations_total",
            "Total number of user registrations"
        )?;
        
        let active_users = Gauge::new(
            "active_users",
            "Number of currently active users"
        )?;
        
        let database_connections = Gauge::new(
            "database_connections",
            "Number of active database connections"
        )?;
        
        // ç³»ç»ŸæŒ‡æ ‡
        let memory_usage_bytes = Gauge::new(
            "memory_usage_bytes",
            "Current memory usage in bytes"
        )?;
        
        let cpu_usage_percent = Gauge::new(
            "cpu_usage_percent",
            "Current CPU usage percentage"
        )?;
        
        // è‡ªå®šä¹‰æŒ‡æ ‡
        let custom_operations_total = CounterVec::new(
            Opts::new("custom_operations_total", "Total number of custom operations")
                .namespace("microservice")
                .subsystem("custom"),
            &["operation_type", "status"],
        )?;
        
        let custom_operation_duration = HistogramVec::new(
            HistogramOpts::new("custom_operation_duration_seconds", "Custom operation duration in seconds")
                .namespace("microservice")
                .subsystem("custom")
                .buckets(vec![0.001, 0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1.0, 2.5, 5.0]),
            &["operation_type"],
        )?;
        
        // æ³¨å†ŒæŒ‡æ ‡
        registry.register(Box::new(http_requests_total.clone()))?;
        registry.register(Box::new(http_request_duration.clone()))?;
        registry.register(Box::new(http_requests_in_flight.clone()))?;
        registry.register(Box::new(user_registrations_total.clone()))?;
        registry.register(Box::new(active_users.clone()))?;
        registry.register(Box::new(database_connections.clone()))?;
        registry.register(Box::new(memory_usage_bytes.clone()))?;
        registry.register(Box::new(cpu_usage_percent.clone()))?;
        registry.register(Box::new(custom_operations_total.clone()))?;
        registry.register(Box::new(custom_operation_duration.clone()))?;
        
        Ok(Metrics {
            http_requests_total,
            http_request_duration,
            http_requests_in_flight,
            user_registrations_total,
            active_users,
            database_connections,
            memory_usage_bytes,
            cpu_usage_percent,
            custom_operations_total,
            custom_operation_duration,
        })
    }
}
```

#### 1.2 Axumä¸­é—´ä»¶é›†æˆ

```rust
// src/middleware/metrics.rs
use axum::{
    extract::Request,
    http::{Method, StatusCode},
    middleware::Next,
    response::Response,
};
use prometheus::{CounterVec, HistogramVec, GaugeVec};
use std::time::Instant;

pub struct MetricsMiddleware {
    requests_total: CounterVec,
    request_duration: HistogramVec,
    requests_in_flight: GaugeVec,
}

impl MetricsMiddleware {
    pub fn new(
        requests_total: CounterVec,
        request_duration: HistogramVec,
        requests_in_flight: GaugeVec,
    ) -> Self {
        Self {
            requests_total,
            request_duration,
            requests_in_flight,
        }
    }
    
    pub async fn middleware(
        &self,
        request: Request,
        next: Next,
    ) -> Result<Response, StatusCode> {
        let start = Instant::now();
        let method = request.method().clone();
        let uri = request.uri().path().to_string();
        
        // å¢åŠ æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°
        self.requests_in_flight
            .with_label_values(&[method.as_str(), &uri])
            .inc();
        
        // å¤„ç†è¯·æ±‚
        let response = next.run(request).await;
        let status = response.status();
        
        // è®°å½•è¯·æ±‚å®Œæˆ
        self.requests_in_flight
            .with_label_values(&[method.as_str(), &uri])
            .dec();
        
        // è®°å½•æŒ‡æ ‡
        self.requests_total
            .with_label_values(&[
                method.as_str(),
                &uri,
                &status.as_str(),
            ])
            .inc();
        
        self.request_duration
            .with_label_values(&[method.as_str(), &uri])
            .observe(start.elapsed().as_secs_f64());
        
        Ok(response)
    }
}

// ä½¿ç”¨ç¤ºä¾‹
pub fn create_router_with_metrics(metrics: Arc<Metrics>) -> axum::Router {
    let metrics_middleware = MetricsMiddleware::new(
        metrics.http_requests_total.clone(),
        metrics.http_request_duration.clone(),
        metrics.http_requests_in_flight.clone(),
    );
    
    axum::Router::new()
        .route("/health", get(health_check))
        .route("/metrics", get(metrics_handler))
        .layer(axum::middleware::from_fn_with_state(
            metrics_middleware,
            |state, request, next| async move {
                state.middleware(request, next).await
            },
        ))
}
```

#### 1.3 Poemä¸­é—´ä»¶é›†æˆ

```rust
// src/middleware/poem_metrics.rs
use poem::{
    middleware::Middleware,
    Endpoint, MiddlewareResult, Request, Response,
};
use prometheus::{CounterVec, HistogramVec, GaugeVec};
use std::time::Instant;

pub struct PoemMetricsMiddleware {
    requests_total: CounterVec,
    request_duration: HistogramVec,
    requests_in_flight: GaugeVec,
}

impl PoemMetricsMiddleware {
    pub fn new(
        requests_total: CounterVec,
        request_duration: HistogramVec,
        requests_in_flight: GaugeVec,
    ) -> Self {
        Self {
            requests_total,
            request_duration,
            requests_in_flight,
        }
    }
}

impl<E: Endpoint> Middleware<E> for PoemMetricsMiddleware {
    type Output = PoemMetricsEndpoint<E>;
    
    fn transform(&self, ep: E) -> Self::Output {
        PoemMetricsEndpoint {
            ep,
            requests_total: self.requests_total.clone(),
            request_duration: self.request_duration.clone(),
            requests_in_flight: self.requests_in_flight.clone(),
        }
    }
}

pub struct PoemMetricsEndpoint<E> {
    ep: E,
    requests_total: CounterVec,
    request_duration: HistogramVec,
    requests_in_flight: GaugeVec,
}

#[poem::async_trait]
impl<E: Endpoint> Endpoint for PoemMetricsEndpoint<E> {
    type Output = Response;
    
    async fn call(&self, mut request: Request) -> MiddlewareResult<Self::Output> {
        let start = Instant::now();
        let method = request.method().as_str();
        let uri = request.uri().path().to_string();
        
        // å¢åŠ æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°
        self.requests_in_flight
            .with_label_values(&[method, &uri])
            .inc();
        
        // å¤„ç†è¯·æ±‚
        let response = self.ep.call(request).await?;
        let status = response.status().as_str();
        
        // è®°å½•è¯·æ±‚å®Œæˆ
        self.requests_in_flight
            .with_label_values(&[method, &uri])
            .dec();
        
        // è®°å½•æŒ‡æ ‡
        self.requests_total
            .with_label_values(&[method, &uri, status])
            .inc();
        
        self.request_duration
            .with_label_values(&[method, &uri])
            .observe(start.elapsed().as_secs_f64());
        
        Ok(response)
    }
}
```

### 2. è‡ªå®šä¹‰æŒ‡æ ‡

```rust
// src/metrics/custom.rs
use prometheus::{Counter, Histogram, Gauge, CounterVec, HistogramVec};
use std::sync::Arc;

pub struct BusinessMetrics {
    // ç”¨æˆ·ç›¸å…³æŒ‡æ ‡
    pub user_registrations: Counter,
    pub user_logins: Counter,
    pub user_logouts: Counter,
    pub active_sessions: Gauge,
    
    // è®¢å•ç›¸å…³æŒ‡æ ‡
    pub orders_created: Counter,
    pub orders_completed: Counter,
    pub orders_cancelled: Counter,
    pub order_value: Histogram,
    
    // æ”¯ä»˜ç›¸å…³æŒ‡æ ‡
    pub payments_initiated: Counter,
    pub payments_completed: Counter,
    pub payments_failed: Counter,
    pub payment_amount: Histogram,
    
    // é”™è¯¯æŒ‡æ ‡
    pub errors_total: CounterVec,
    pub error_rate: Gauge,
}

impl BusinessMetrics {
    pub fn new() -> Result<Self, prometheus::Error> {
        let user_registrations = Counter::new(
            "user_registrations_total",
            "Total number of user registrations"
        )?;
        
        let user_logins = Counter::new(
            "user_logins_total",
            "Total number of user logins"
        )?;
        
        let user_logouts = Counter::new(
            "user_logouts_total",
            "Total number of user logouts"
        )?;
        
        let active_sessions = Gauge::new(
            "active_sessions",
            "Number of currently active user sessions"
        )?;
        
        let orders_created = Counter::new(
            "orders_created_total",
            "Total number of orders created"
        )?;
        
        let orders_completed = Counter::new(
            "orders_completed_total",
            "Total number of orders completed"
        )?;
        
        let orders_cancelled = Counter::new(
            "orders_cancelled_total",
            "Total number of orders cancelled"
        )?;
        
        let order_value = Histogram::new(
            "order_value",
            "Order value distribution"
        )?;
        
        let payments_initiated = Counter::new(
            "payments_initiated_total",
            "Total number of payments initiated"
        )?;
        
        let payments_completed = Counter::new(
            "payments_completed_total",
            "Total number of payments completed"
        )?;
        
        let payments_failed = Counter::new(
            "payments_failed_total",
            "Total number of payments failed"
        )?;
        
        let payment_amount = Histogram::new(
            "payment_amount",
            "Payment amount distribution"
        )?;
        
        let errors_total = CounterVec::new(
            "errors_total",
            "Total number of errors by type",
            &["error_type", "service"]
        )?;
        
        let error_rate = Gauge::new(
            "error_rate",
            "Current error rate percentage"
        )?;
        
        Ok(BusinessMetrics {
            user_registrations,
            user_logins,
            user_logouts,
            active_sessions,
            orders_created,
            orders_completed,
            orders_cancelled,
            order_value,
            payments_initiated,
            payments_completed,
            payments_failed,
            payment_amount,
            errors_total,
            error_rate,
        })
    }
}
```

## ğŸ“ æ—¥å¿—èšåˆ

### 1. ç»“æ„åŒ–æ—¥å¿—é…ç½®

```rust
// src/logging/mod.rs
use tracing::{info, warn, error, debug};
use tracing_subscriber::{
    fmt, layer::SubscriberExt, util::SubscriberInitExt, EnvFilter, Registry,
};
use tracing_opentelemetry::OpenTelemetrySpanExt;

pub fn setup_logging() -> Result<(), Box<dyn std::error::Error>> {
    // ç¯å¢ƒè¿‡æ»¤å™¨
    let env_filter = EnvFilter::try_from_default_env()
        .unwrap_or_else(|_| EnvFilter::new("info"));
    
    // JSONæ ¼å¼åŒ–å™¨
    let json_layer = fmt::layer()
        .json()
        .with_current_span(true)
        .with_span_list(true)
        .with_target(true)
        .with_thread_ids(true)
        .with_thread_names(true)
        .with_file(true)
        .with_line_number(true);
    
    // æ§åˆ¶å°æ ¼å¼åŒ–å™¨ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    let console_layer = fmt::layer()
        .pretty()
        .with_target(false)
        .with_thread_ids(true)
        .with_thread_names(true);
    
    // æ ¹æ®ç¯å¢ƒé€‰æ‹©æ ¼å¼åŒ–å™¨
    let format_layer = if std::env::var("RUST_LOG_FORMAT").unwrap_or_default() == "json" {
        json_layer.boxed()
    } else {
        console_layer.boxed()
    };
    
    // åˆå§‹åŒ–è®¢é˜…è€…
    Registry::default()
        .with(env_filter)
        .with(format_layer)
        .init();
    
    Ok(())
}

// ä¸šåŠ¡æ—¥å¿—å®
#[macro_export]
macro_rules! business_log {
    ($level:ident, $event:expr, $($field:tt)*) => {
        tracing::$level!(
            event = $event,
            $($field)*
        );
    };
}

// ä½¿ç”¨ç¤ºä¾‹
pub fn log_user_registration(user_id: u64, email: &str) {
    business_log!(
        info,
        "user_registered",
        user_id = user_id,
        email = email,
        timestamp = chrono::Utc::now().to_rfc3339()
    );
}

pub fn log_order_created(order_id: u64, user_id: u64, amount: f64) {
    business_log!(
        info,
        "order_created",
        order_id = order_id,
        user_id = user_id,
        amount = amount,
        currency = "USD"
    );
}

pub fn log_payment_failed(payment_id: u64, error: &str) {
    business_log!(
        error,
        "payment_failed",
        payment_id = payment_id,
        error = error,
        retry_count = 0
    );
}
```

### 2. Lokié›†æˆ

```yaml
# k8s/loki.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-config
  namespace: monitoring
data:
  loki.yml: |
    auth_enabled: false
    
    server:
      http_listen_port: 3100
      grpc_listen_port: 9096
    
    common:
      path_prefix: /loki
      storage:
        filesystem:
          chunks_directory: /loki/chunks
          rules_directory: /loki/rules
      replication_factor: 1
      ring:
        instance_addr: 127.0.0.1
        kvstore:
          store: inmemory
    
    query_scheduler:
      max_outstanding_requests_per_tenant: 2048
    
    schema_config:
      configs:
        - from: 2020-10-24
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: index_
            period: 24h
    
    ruler:
      alertmanager_url: http://localhost:9093
    
    limits_config:
      enforce_metric_name: false
      reject_old_samples: true
      reject_old_samples_max_age: 168h
      max_cache_freshness_per_query: 10m
      split_queries_by_interval: 15m
      max_query_parallelism: 32
      max_streams_per_user: 0
      max_line_size: 256000
    
    chunk_store_config:
      max_look_back_period: 0s
    
    table_manager:
      retention_deletes_enabled: false
      retention_period: 0s
    
    compactor:
      working_directory: /loki
      shared_store: filesystem
      compaction_interval: 10m
      retention_enabled: true
      retention_delete_delay: 2h
      retention_delete_worker_count: 150
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loki
  template:
    metadata:
      labels:
        app: loki
    spec:
      containers:
      - name: loki
        image: grafana/loki:2.9.0
        ports:
        - containerPort: 3100
        volumeMounts:
        - name: config
          mountPath: /etc/loki
        - name: storage
          mountPath: /loki
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
      volumes:
      - name: config
        configMap:
          name: loki-config
      - name: storage
        persistentVolumeClaim:
          claimName: loki-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: loki
  namespace: monitoring
spec:
  selector:
    app: loki
  ports:
  - port: 3100
    targetPort: 3100
```

### 3. Promtailé…ç½®

```yaml
# k8s/promtail.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: monitoring
data:
  promtail.yml: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0
    
    positions:
      filename: /tmp/positions.yaml
    
    clients:
      - url: http://loki:3100/loki/api/v1/push
    
    scrape_configs:
    - job_name: kubernetes-pods
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_controller_name]
        regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})?
        action: replace
        target_label: __tmp_controller_name
      - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name, __meta_kubernetes_pod_label_app, __meta_kubernetes_pod_label_name, __tmp_controller_name, __meta_kubernetes_pod_node_name]
        action: replace
        regex: ^;*([^;]+)(;.*)?$
        replacement: $1
        target_label: app
      - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_instance, __meta_kubernetes_pod_label_instance]
        action: replace
        regex: ^;*([^;]+)(;.*)?$
        replacement: $1
        target_label: instance
      - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_component, __meta_kubernetes_pod_label_component]
        action: replace
        regex: ^;*([^;]+)(;.*)?$
        replacement: $1
        target_label: component
      - action: replace
        source_labels: [__meta_kubernetes_pod_node_name]
        target_label: node_name
      - action: replace
        source_labels: [__meta_kubernetes_namespace]
        target_label: namespace
      - action: replace
        source_labels: [__meta_kubernetes_pod_name]
        target_label: pod
      - action: replace
        source_labels: [__meta_kubernetes_pod_container_name]
        target_label: container
      - replacement: /var/log/pods/*$1/*.log
        separator: /
        source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
        target_label: __path__
      - action: replace
        replacement: $1
        source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
        target_label: job
      - action: replace
        source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        regex: "true"
        action: keep
      - action: replace
        source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        regex: (.+)
        target_label: __metrics_path__
        action: replace
      - action: replace
        source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: promtail
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: promtail
  template:
    metadata:
      labels:
        app: promtail
    spec:
      containers:
      - name: promtail
        image: grafana/promtail:2.9.0
        ports:
        - containerPort: 9080
        volumeMounts:
        - name: config
          mountPath: /etc/promtail
        - name: varlog
          mountPath: /var/log
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "100m"
      volumes:
      - name: config
        configMap:
          name: promtail-config
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
```

## ğŸ” åˆ†å¸ƒå¼è¿½è¸ª

### 1. OpenTelemetryé›†æˆ

```rust
// src/tracing/opentelemetry.rs
use opentelemetry::{
    global,
    sdk::{
        trace::{self, RandomIdGenerator, Sampler},
        Resource,
    },
    trace::{TraceError, Tracer},
    KeyValue,
};
use opentelemetry_jaeger::new_agent_pipeline;
use opentelemetry_otlp::new_pipeline;
use tracing_opentelemetry::OpenTelemetrySpanExt;
use tracing_subscriber::{layer::SubscriberExt, util::SubscriberInitExt, Registry};

pub fn setup_tracing() -> Result<(), TraceError> {
    // åˆ›å»ºèµ„æº
    let resource = Resource::new(vec![
        KeyValue::new("service.name", "microservice"),
        KeyValue::new("service.version", env!("CARGO_PKG_VERSION")),
        KeyValue::new("service.namespace", "production"),
    ]);
    
    // é…ç½®é‡‡æ ·å™¨
    let sampler = Sampler::TraceIdRatioBased(0.1); // 10%é‡‡æ ·ç‡
    
    // åˆ›å»ºè¿½è¸ªå™¨
    let tracer = new_agent_pipeline()
        .with_service_name("microservice")
        .with_agent_endpoint("http://jaeger:14268/api/traces")
        .with_trace_config(
            trace::config()
                .with_sampler(sampler)
                .with_id_generator(RandomIdGenerator::default())
                .with_resource(resource),
        )
        .install_simple()?;
    
    // è®¾ç½®å…¨å±€è¿½è¸ªå™¨
    global::set_tracer_provider(tracer.provider().unwrap());
    
    // åˆå§‹åŒ–è¿½è¸ªè®¢é˜…è€…
    Registry::default()
        .with(tracing_opentelemetry::layer().with_tracer(tracer))
        .init();
    
    Ok(())
}

// è¿½è¸ªå®
#[macro_export]
macro_rules! trace_operation {
    ($name:expr, $($field:tt)*) => {
        tracing::info_span!($name, $($field)*)
    };
}

// ä½¿ç”¨ç¤ºä¾‹
pub async fn process_user_registration(user_data: UserData) -> Result<User, ServiceError> {
    let span = trace_operation!(
        "user_registration",
        user_id = user_data.id,
        email = user_data.email.as_str()
    );
    
    let _enter = span.enter();
    
    // ä¸šåŠ¡é€»è¾‘
    let user = create_user(user_data).await?;
    
    tracing::info!("User registered successfully");
    Ok(user)
}
```

### 2. Jaegeré…ç½®

```yaml
# k8s/jaeger.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger
  template:
    metadata:
      labels:
        app: jaeger
    spec:
      containers:
      - name: jaeger
        image: jaegertracing/all-in-one:1.47
        ports:
        - containerPort: 16686
          name: ui
        - containerPort: 14268
          name: http
        - containerPort: 14250
          name: grpc
        env:
        - name: COLLECTOR_OTLP_ENABLED
          value: "true"
        - name: SPAN_STORAGE_TYPE
          value: "memory"
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
---
apiVersion: v1
kind: Service
metadata:
  name: jaeger
  namespace: monitoring
spec:
  selector:
    app: jaeger
  ports:
  - name: ui
    port: 16686
    targetPort: 16686
  - name: http
    port: 14268
    targetPort: 14268
  - name: grpc
    port: 14250
    targetPort: 14250
```

## ğŸš¨ å‘Šè­¦é…ç½®

### 1. AlertManageré…ç½®

```yaml
# k8s/alertmanager.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
data:
  alertmanager.yml: |
    global:
      smtp_smarthost: 'localhost:587'
      smtp_from: 'alerts@microservice.com'
    
    route:
      group_by: ['alertname']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'web.hook'
      routes:
      - match:
          severity: critical
        receiver: 'critical-alerts'
      - match:
          severity: warning
        receiver: 'warning-alerts'
    
    receivers:
    - name: 'web.hook'
      webhook_configs:
      - url: 'http://webhook:5001/'
    
    - name: 'critical-alerts'
      email_configs:
      - to: 'admin@microservice.com'
        subject: 'CRITICAL: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          {{ end }}
      slack_configs:
      - api_url: 'YOUR_SLACK_WEBHOOK_URL'
        channel: '#alerts'
        title: 'Critical Alert'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
    
    - name: 'warning-alerts'
      email_configs:
      - to: 'team@microservice.com'
        subject: 'WARNING: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          {{ end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: alertmanager
  template:
    metadata:
      labels:
        app: alertmanager
    spec:
      containers:
      - name: alertmanager
        image: prom/alertmanager:latest
        ports:
        - containerPort: 9093
        volumeMounts:
        - name: config
          mountPath: /etc/alertmanager
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "100m"
      volumes:
      - name: config
        configMap:
          name: alertmanager-config
---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: monitoring
spec:
  selector:
    app: alertmanager
  ports:
  - port: 9093
    targetPort: 9093
```

### 2. å‘Šè­¦è§„åˆ™

```yaml
# k8s/alert-rules.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: alert-rules
  namespace: monitoring
data:
  microservice-alerts.yml: |
    groups:
    - name: microservice.rules
      rules:
      # é«˜é”™è¯¯ç‡å‘Šè­¦
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
          service: microservice
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors per second for service {{ $labels.service }}"
          runbook_url: "https://wiki.company.com/runbooks/high-error-rate"
      
      # é«˜å»¶è¿Ÿå‘Šè­¦
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          service: microservice
        annotations:
          summary: "High latency detected"
          description: "95th percentile latency is {{ $value }} seconds for service {{ $labels.service }}"
      
      # Podå´©æºƒå‘Šè­¦
      - alert: PodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
        for: 5m
        labels:
          severity: critical
          service: microservice
        annotations:
          summary: "Pod is crash looping"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting frequently"
      
      # å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
      - alert: HighMemoryUsage
        expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) > 0.8
        for: 5m
        labels:
          severity: warning
          service: microservice
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value | humanizePercentage }} for pod {{ $labels.pod }}"
      
      # CPUä½¿ç”¨ç‡å‘Šè­¦
      - alert: HighCPUUsage
        expr: rate(container_cpu_usage_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          service: microservice
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value | humanizePercentage }} for pod {{ $labels.pod }}"
      
      # æ•°æ®åº“è¿æ¥æ•°å‘Šè­¦
      - alert: HighDatabaseConnections
        expr: database_connections > 80
        for: 5m
        labels:
          severity: warning
          service: microservice
        annotations:
          summary: "High database connections"
          description: "Database connections are {{ $value }} for service {{ $labels.service }}"
      
      # ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦
      - alert: LowUserRegistrations
        expr: rate(user_registrations_total[1h]) < 1
        for: 30m
        labels:
          severity: warning
          service: microservice
        annotations:
          summary: "Low user registration rate"
          description: "User registration rate is {{ $value }} per hour"
      
      - alert: HighPaymentFailureRate
        expr: rate(payments_failed_total[5m]) / rate(payments_initiated_total[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
          service: microservice
        annotations:
          summary: "High payment failure rate"
          description: "Payment failure rate is {{ $value | humanizePercentage }}"
```

## ğŸ“Š Grafanaä»ªè¡¨æ¿

### 1. åŸºç¡€ä»ªè¡¨æ¿é…ç½®

```json
{
  "dashboard": {
    "id": null,
    "title": "Microservice Overview",
    "tags": ["microservice", "overview"],
    "timezone": "browser",
    "panels": [
      {
        "id": 1,
        "title": "Request Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{endpoint}}"
          }
        ],
        "yAxes": [
          {
            "label": "requests/sec",
            "min": 0
          }
        ]
      },
      {
        "id": 2,
        "title": "Response Time",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95th percentile"
          },
          {
            "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "50th percentile"
          }
        ],
        "yAxes": [
          {
            "label": "seconds",
            "min": 0
          }
        ]
      },
      {
        "id": 3,
        "title": "Error Rate",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m])",
            "legendFormat": "Error Rate"
          }
        ],
        "yAxes": [
          {
            "label": "percentage",
            "min": 0,
            "max": 1
          }
        ]
      },
      {
        "id": 4,
        "title": "Active Users",
        "type": "singlestat",
        "targets": [
          {
            "expr": "active_users",
            "legendFormat": "Active Users"
          }
        ],
        "valueName": "current"
      }
    ],
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "refresh": "30s"
  }
}
```

### 2. ä¸šåŠ¡æŒ‡æ ‡ä»ªè¡¨æ¿

```json
{
  "dashboard": {
    "id": null,
    "title": "Business Metrics",
    "tags": ["microservice", "business"],
    "panels": [
      {
        "id": 1,
        "title": "User Registrations",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(user_registrations_total[1h])",
            "legendFormat": "Registrations/hour"
          }
        ]
      },
      {
        "id": 2,
        "title": "Order Value Distribution",
        "type": "histogram",
        "targets": [
          {
            "expr": "order_value",
            "legendFormat": "Order Value"
          }
        ]
      },
      {
        "id": 3,
        "title": "Payment Success Rate",
        "type": "singlestat",
        "targets": [
          {
            "expr": "rate(payments_completed_total[5m]) / rate(payments_initiated_total[5m])",
            "legendFormat": "Success Rate"
          }
        ],
        "valueName": "current",
        "format": "percentunit"
      }
    ]
  }
}
```

## ğŸ”§ éƒ¨ç½²è„šæœ¬

### 1. ç›‘æ§æ ˆéƒ¨ç½²

```bash
#!/bin/bash
# scripts/deploy_monitoring.sh

set -e

NAMESPACE="monitoring"

echo "ğŸ“Š å¼€å§‹éƒ¨ç½²ç›‘æ§æ ˆ..."

# 1. åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

# 2. éƒ¨ç½²Prometheus
kubectl apply -f k8s/prometheus.yaml

# 3. éƒ¨ç½²AlertManager
kubectl apply -f k8s/alertmanager.yaml

# 4. éƒ¨ç½²Loki
kubectl apply -f k8s/loki.yaml

# 5. éƒ¨ç½²Promtail
kubectl apply -f k8s/promtail.yaml

# 6. éƒ¨ç½²Jaeger
kubectl apply -f k8s/jaeger.yaml

# 7. éƒ¨ç½²Grafana
kubectl apply -f k8s/grafana.yaml

# 8. ç­‰å¾…éƒ¨ç½²å®Œæˆ
kubectl wait --for=condition=ready pod -l app=prometheus -n $NAMESPACE --timeout=300s
kubectl wait --for=condition=ready pod -l app=grafana -n $NAMESPACE --timeout=300s

echo "âœ… ç›‘æ§æ ˆéƒ¨ç½²å®Œæˆ"
echo "ğŸ“Š Grafana: http://localhost:3000 (admin/admin)"
echo "ğŸ” Jaeger: http://localhost:16686"
echo "ğŸ“ˆ Prometheus: http://localhost:9090"
```

### 2. å¥åº·æ£€æŸ¥è„šæœ¬

```bash
#!/bin/bash
# scripts/health_check.sh

set -e

echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."

# 1. æ£€æŸ¥Prometheus
echo "æ£€æŸ¥Prometheus..."
if curl -f http://localhost:9090/-/healthy > /dev/null 2>&1; then
    echo "âœ… Prometheuså¥åº·"
else
    echo "âŒ Prometheusä¸å¥åº·"
    exit 1
fi

# 2. æ£€æŸ¥Grafana
echo "æ£€æŸ¥Grafana..."
if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
    echo "âœ… Grafanaå¥åº·"
else
    echo "âŒ Grafanaä¸å¥åº·"
    exit 1
fi

# 3. æ£€æŸ¥Jaeger
echo "æ£€æŸ¥Jaeger..."
if curl -f http://localhost:16686/api/services > /dev/null 2>&1; then
    echo "âœ… Jaegerå¥åº·"
else
    echo "âŒ Jaegerä¸å¥åº·"
    exit 1
fi

# 4. æ£€æŸ¥åº”ç”¨æŒ‡æ ‡
echo "æ£€æŸ¥åº”ç”¨æŒ‡æ ‡..."
if curl -f http://localhost:8080/metrics > /dev/null 2>&1; then
    echo "âœ… åº”ç”¨æŒ‡æ ‡æ­£å¸¸"
else
    echo "âŒ åº”ç”¨æŒ‡æ ‡å¼‚å¸¸"
    exit 1
fi

echo "ğŸ‰ æ‰€æœ‰å¥åº·æ£€æŸ¥é€šè¿‡"
```

## ğŸ“š æœ€ä½³å®è·µæ€»ç»“

### 1. ç›‘æ§è®¾è®¡åŸåˆ™

- **å››ä¸ªé»„é‡‘ä¿¡å·**: å»¶è¿Ÿã€æµé‡ã€é”™è¯¯ã€é¥±å’Œåº¦
- **SLI/SLOå®šä¹‰**: æ˜ç¡®å®šä¹‰æœåŠ¡çº§åˆ«æŒ‡æ ‡å’Œç›®æ ‡
- **åˆ†å±‚ç›‘æ§**: åŸºç¡€è®¾æ–½ã€åº”ç”¨ã€ä¸šåŠ¡ä¸‰å±‚ç›‘æ§
- **è‡ªåŠ¨åŒ–å‘Šè­¦**: å‡å°‘è¯¯æŠ¥ï¼Œæé«˜å‘Šè­¦è´¨é‡

### 2. æŒ‡æ ‡è®¾è®¡

- **å‘½åè§„èŒƒ**: ä½¿ç”¨ç»Ÿä¸€çš„å‘½åçº¦å®š
- **æ ‡ç­¾è®¾è®¡**: åˆç†ä½¿ç”¨æ ‡ç­¾ï¼Œé¿å…é«˜åŸºæ•°
- **æŒ‡æ ‡ç±»å‹**: æ­£ç¡®é€‰æ‹©Counterã€Gaugeã€Histogram
- **ä¸šåŠ¡æŒ‡æ ‡**: å…³æ³¨ä¸šåŠ¡å…³é”®æŒ‡æ ‡

### 3. æ—¥å¿—ç®¡ç†

- **ç»“æ„åŒ–æ—¥å¿—**: ä½¿ç”¨JSONæ ¼å¼ï¼Œä¾¿äºè§£æ
- **æ—¥å¿—çº§åˆ«**: åˆç†ä½¿ç”¨ä¸åŒæ—¥å¿—çº§åˆ«
- **æ•æ„Ÿä¿¡æ¯**: é¿å…è®°å½•æ•æ„Ÿä¿¡æ¯
- **æ—¥å¿—è½®è½¬**: é…ç½®åˆç†çš„æ—¥å¿—è½®è½¬ç­–ç•¥

### 4. è¿½è¸ªç­–ç•¥

- **é‡‡æ ·ç‡**: æ ¹æ®ç³»ç»Ÿè´Ÿè½½è°ƒæ•´é‡‡æ ·ç‡
- **ä¸Šä¸‹æ–‡ä¼ æ’­**: ç¡®ä¿è¿½è¸ªä¸Šä¸‹æ–‡æ­£ç¡®ä¼ æ’­
- **æ€§èƒ½å½±å“**: ç›‘æ§è¿½è¸ªå¯¹æ€§èƒ½çš„å½±å“
- **å­˜å‚¨ä¼˜åŒ–**: åˆç†é…ç½®è¿½è¸ªæ•°æ®å­˜å‚¨

## ğŸ”— ç›¸å…³èµ„æº

- [Prometheuså®˜æ–¹æ–‡æ¡£](https://prometheus.io/docs/)
- [Grafanaå®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/)
- [Jaegerå®˜æ–¹æ–‡æ¡£](https://www.jaegertracing.io/docs/)
- [OpenTelemetryå®˜æ–¹æ–‡æ¡£](https://opentelemetry.io/docs/)
- [äº‘åŸç”Ÿéƒ¨ç½²å®Œæ•´æµç¨‹](./äº‘åŸç”Ÿéƒ¨ç½²å®Œæ•´æµç¨‹.md)

---

**æ³¨æ„**: æœ¬æ–‡æ¡£åŸºäº2025å¹´9æœˆçš„æœ€æ–°æŠ€æœ¯æ ˆï¼Œå»ºè®®å®šæœŸæ›´æ–°ä»¥ä¿æŒæ—¶æ•ˆæ€§ã€‚
