# äº‘åŸç”Ÿéƒ¨ç½²å®Œæ•´æµç¨‹

> åŸºäºRust 1.90å’Œæœ€æ–°ä¾èµ–ç‰ˆæœ¬çš„äº‘åŸç”Ÿå¾®æœåŠ¡éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„äº‘åŸç”Ÿéƒ¨ç½²æµç¨‹ï¼ŒåŒ…æ‹¬å®¹å™¨åŒ–ã€Kubernetesç¼–æ’ã€æœåŠ¡ç½‘æ ¼é›†æˆã€ç›‘æ§å‘Šè­¦ç­‰å…¨æ ˆè§£å†³æ–¹æ¡ˆã€‚

## ğŸ¯ éƒ¨ç½²æ¶æ„

### 1. æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "ç”¨æˆ·å±‚"
        U[ç”¨æˆ·] --> LB[è´Ÿè½½å‡è¡¡å™¨]
    end
    
    subgraph "ç½‘å…³å±‚"
        LB --> GW[APIç½‘å…³]
        GW --> ISTIO[Istio Service Mesh]
    end
    
    subgraph "åº”ç”¨å±‚"
        ISTIO --> MS1[å¾®æœåŠ¡1 - Axum]
        ISTIO --> MS2[å¾®æœåŠ¡2 - Poem]
        ISTIO --> MS3[å¾®æœåŠ¡3 - Volo RPC]
    end
    
    subgraph "æ•°æ®å±‚"
        MS1 --> DB[(PostgreSQL)]
        MS2 --> CACHE[(Redis)]
        MS3 --> MQ[æ¶ˆæ¯é˜Ÿåˆ—]
    end
    
    subgraph "ç›‘æ§å±‚"
        MS1 --> PROM[Prometheus]
        MS2 --> JAEGER[Jaeger]
        MS3 --> GRAFANA[Grafana]
    end
```

### 2. æŠ€æœ¯æ ˆé€‰æ‹©

| ç»„ä»¶ | æŠ€æœ¯é€‰æ‹© | ç‰ˆæœ¬ | ç†ç”± |
|------|----------|------|------|
| å®¹å™¨è¿è¡Œæ—¶ | Docker | 24.0+ | æ ‡å‡†åŒ–å®¹å™¨åŒ– |
| ç¼–æ’å¹³å° | Kubernetes | 1.28+ | äº‘åŸç”Ÿæ ‡å‡† |
| æœåŠ¡ç½‘æ ¼ | Istio | 1.19+ | æµé‡ç®¡ç†ã€å®‰å…¨ |
| APIç½‘å…³ | Istio Gateway | 1.19+ | ç»Ÿä¸€å…¥å£ |
| ç›‘æ§ | Prometheus + Grafana | æœ€æ–° | æŒ‡æ ‡ç›‘æ§ |
| è¿½è¸ª | Jaeger | æœ€æ–° | åˆ†å¸ƒå¼è¿½è¸ª |
| æ—¥å¿— | ELK Stack | æœ€æ–° | æ—¥å¿—èšåˆ |

## ğŸ³ å®¹å™¨åŒ–

### 1. Dockerfileä¼˜åŒ–

#### 1.1 å¤šé˜¶æ®µæ„å»º

```dockerfile
# Dockerfile
# æ„å»ºé˜¶æ®µ
FROM rust:1.90-slim as builder

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶Cargoæ–‡ä»¶
COPY Cargo.toml Cargo.lock ./

# æ„å»ºä¾èµ–ï¼ˆåˆ©ç”¨Dockerç¼“å­˜ï¼‰
RUN cargo build --release --locked

# å¤åˆ¶æºä»£ç 
COPY src ./src
COPY examples ./examples
COPY benches ./benches

# é‡æ–°æ„å»ºï¼ˆåªç¼–è¯‘æºä»£ç å˜æ›´ï¼‰
RUN touch src/main.rs && cargo build --release --locked

# è¿è¡Œé˜¶æ®µ
FROM debian:bookworm-slim

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3 \
    libpq5 \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser appuser

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /app/target/release/microservice-server /app/
COPY --from=builder /app/target/release/microservice-client /app/

# è®¾ç½®æƒé™
RUN chown -R appuser:appuser /app
USER appuser

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¯åŠ¨å‘½ä»¤
CMD ["./microservice-server"]
```

#### 1.2 å®‰å…¨ä¼˜åŒ–

```dockerfile
# Dockerfile.security
FROM rust:1.90-slim as builder

# ä½¿ç”¨érootç”¨æˆ·æ„å»º
RUN groupadd -r builder && useradd -r -g builder builder
USER builder

# è®¾ç½®å®‰å…¨çš„ç¯å¢ƒå˜é‡
ENV RUSTFLAGS="-C target-cpu=native -C opt-level=3"
ENV CARGO_INCREMENTAL=0
ENV CARGO_PROFILE_RELEASE_LTO=true
ENV CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1

# æ„å»ºé…ç½®
WORKDIR /home/builder/app
COPY --chown=builder:builder Cargo.toml Cargo.lock ./
RUN cargo build --release --locked

COPY --chown=builder:builder src ./src
RUN touch src/main.rs && cargo build --release --locked

# è¿è¡Œé˜¶æ®µ
FROM gcr.io/distroless/cc-debian12

# å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /home/builder/app/target/release/microservice-server /app/

# ä½¿ç”¨éç‰¹æƒç”¨æˆ·
USER 65534:65534

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["/app/microservice-server"]
```

### 2. æ„å»ºè„šæœ¬

```bash
#!/bin/bash
# scripts/build_docker.sh

set -e

# é…ç½®
IMAGE_NAME="microservice"
VERSION="${1:-latest}"
REGISTRY="${2:-your-registry.com}"

echo "ğŸ³ å¼€å§‹æ„å»ºDockeré•œåƒ..."

# 1. æ„å»ºé•œåƒ
echo "æ„å»ºé•œåƒ: $REGISTRY/$IMAGE_NAME:$VERSION"
docker build -t "$REGISTRY/$IMAGE_NAME:$VERSION" .

# 2. å®‰å…¨æ‰«æ
echo "æ‰§è¡Œå®‰å…¨æ‰«æ..."
if command -v trivy &> /dev/null; then
    trivy image "$REGISTRY/$IMAGE_NAME:$VERSION"
else
    echo "Trivyæœªå®‰è£…ï¼Œè·³è¿‡å®‰å…¨æ‰«æ"
fi

# 3. é•œåƒä¼˜åŒ–
echo "ä¼˜åŒ–é•œåƒå¤§å°..."
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
    wagoodman/dive:latest "$REGISTRY/$IMAGE_NAME:$VERSION"

# 4. æ¨é€åˆ°ä»“åº“
echo "æ¨é€é•œåƒåˆ°ä»“åº“..."
docker push "$REGISTRY/$IMAGE_NAME:$VERSION"

echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"
```

## â˜¸ï¸ Kuberneteséƒ¨ç½²

### 1. å‘½åç©ºé—´é…ç½®

```yaml
# k8s/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: microservice
  labels:
    name: microservice
    istio-injection: enabled
```

### 2. é…ç½®ç®¡ç†

```yaml
# k8s/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: microservice-config
  namespace: microservice
data:
  config.toml: |
    [server]
    host = "0.0.0.0"
    port = 8080
    
    [database]
    url = "postgresql://user:password@postgres:5432/microservice"
    
    [redis]
    url = "redis://redis:6379"
    
    [logging]
    level = "info"
    format = "json"
    
    [metrics]
    enabled = true
    port = 9090
```

```yaml
# k8s/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: microservice-secrets
  namespace: microservice
type: Opaque
data:
  database-password: <base64-encoded-password>
  jwt-secret: <base64-encoded-jwt-secret>
  api-key: <base64-encoded-api-key>
```

### 3. æ•°æ®åº“éƒ¨ç½²

```yaml
# k8s/postgres.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: microservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: microservice
        - name: POSTGRES_USER
          value: user
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: microservice-secrets
              key: database-password
        volumeMounts:
        - name: postgres-storage
          mountPath: /var/lib/postgresql/data
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      volumes:
      - name: postgres-storage
        persistentVolumeClaim:
          claimName: postgres-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: microservice
spec:
  selector:
    app: postgres
  ports:
  - port: 5432
    targetPort: 5432
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: microservice
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
```

### 4. Rediséƒ¨ç½²

```yaml
# k8s/redis.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: microservice
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: microservice
spec:
  selector:
    app: redis
  ports:
  - port: 6379
    targetPort: 6379
```

### 5. å¾®æœåŠ¡éƒ¨ç½²

```yaml
# k8s/microservice.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: microservice
  namespace: microservice
spec:
  replicas: 3
  selector:
    matchLabels:
      app: microservice
  template:
    metadata:
      labels:
        app: microservice
        version: v1
    spec:
      containers:
      - name: microservice
        image: your-registry.com/microservice:latest
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 9090
          name: metrics
        env:
        - name: RUST_LOG
          value: "info"
        - name: CONFIG_PATH
          value: "/app/config/config.toml"
        volumeMounts:
        - name: config
          mountPath: /app/config
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: microservice-config
---
apiVersion: v1
kind: Service
metadata:
  name: microservice
  namespace: microservice
spec:
  selector:
    app: microservice
  ports:
  - name: http
    port: 80
    targetPort: 8080
  - name: metrics
    port: 9090
    targetPort: 9090
```

## ğŸŒ æœåŠ¡ç½‘æ ¼é›†æˆ

### 1. Istioå®‰è£…

```bash
#!/bin/bash
# scripts/install_istio.sh

set -e

echo "ğŸŒ å®‰è£…IstioæœåŠ¡ç½‘æ ¼..."

# 1. ä¸‹è½½Istio
curl -L https://istio.io/downloadIstio | sh -
cd istio-*

# 2. å®‰è£…Istio
./bin/istioctl install --set values.defaultRevision=default -y

# 3. å¯ç”¨sidecarè‡ªåŠ¨æ³¨å…¥
kubectl label namespace microservice istio-injection=enabled

# 4. éªŒè¯å®‰è£…
./bin/istioctl verify-install

echo "âœ… Istioå®‰è£…å®Œæˆ"
```

### 2. ç½‘å…³é…ç½®

```yaml
# k8s/gateway.yaml
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: microservice-gateway
  namespace: microservice
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - microservice.example.com
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: microservice-tls
    hosts:
    - microservice.example.com
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: microservice-vs
  namespace: microservice
spec:
  hosts:
  - microservice.example.com
  gateways:
  - microservice-gateway
  http:
  - match:
    - uri:
        prefix: /api/v1
    route:
    - destination:
        host: microservice
        port:
          number: 80
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
```

### 3. æµé‡ç®¡ç†

```yaml
# k8s/traffic-management.yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: microservice-dr
  namespace: microservice
spec:
  host: microservice
  trafficPolicy:
    loadBalancer:
      simple: LEAST_CONN
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        maxRequestsPerConnection: 10
    circuitBreaker:
      consecutiveErrors: 3
      interval: 30s
      baseEjectionTime: 30s
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: microservice-canary
  namespace: microservice
spec:
  hosts:
  - microservice
  http:
  - match:
    - headers:
        canary:
          exact: "true"
    route:
    - destination:
        host: microservice
        subset: v2
        port:
          number: 80
      weight: 100
  - route:
    - destination:
        host: microservice
        subset: v1
        port:
          number: 80
      weight: 90
    - destination:
        host: microservice
        subset: v2
        port:
          number: 80
      weight: 10
```

## ğŸ“Š ç›‘æ§ä¸å‘Šè­¦

### 1. Prometheusé…ç½®

```yaml
# k8s/prometheus.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    rule_files:
    - "alert_rules.yml"
    
    scrape_configs:
    - job_name: 'kubernetes-pods'
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name
    
    alerting:
      alertmanagers:
      - static_configs:
        - targets:
          - alertmanager:9093
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - name: prometheus
        image: prom/prometheus:latest
        ports:
        - containerPort: 9090
        volumeMounts:
        - name: config
          mountPath: /etc/prometheus
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
      volumes:
      - name: config
        configMap:
          name: prometheus-config
---
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: monitoring
spec:
  selector:
    app: prometheus
  ports:
  - port: 9090
    targetPort: 9090
```

### 2. Grafanaé…ç½®

```yaml
# k8s/grafana.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:latest
        ports:
        - containerPort: 3000
        env:
        - name: GF_SECURITY_ADMIN_PASSWORD
          value: "admin"
        volumeMounts:
        - name: grafana-storage
          mountPath: /var/lib/grafana
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
      volumes:
      - name: grafana-storage
        persistentVolumeClaim:
          claimName: grafana-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: monitoring
spec:
  selector:
    app: grafana
  ports:
  - port: 3000
    targetPort: 3000
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-pvc
  namespace: monitoring
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
```

### 3. å‘Šè­¦è§„åˆ™

```yaml
# k8s/alert-rules.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: alert-rules
  namespace: monitoring
data:
  alert_rules.yml: |
    groups:
    - name: microservice
      rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors per second"
      
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency detected"
          description: "95th percentile latency is {{ $value }} seconds"
      
      - alert: PodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Pod is crash looping"
          description: "Pod {{ $labels.pod }} is restarting frequently"
```

## ğŸ”„ CI/CDæµæ°´çº¿

### 1. GitHub Actions

```yaml
# .github/workflows/deploy.yml
name: Deploy to Kubernetes

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        components: rustfmt, clippy
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Run tests
      run: cargo test --all-features
    
    - name: Run clippy
      run: cargo clippy --all-targets --all-features -- -D warnings
    
    - name: Check formatting
      run: cargo fmt --all -- --check

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG }}
    
    - name: Deploy to Kubernetes
      run: |
        # æ›´æ–°é•œåƒæ ‡ç­¾
        sed -i "s|image: .*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}|g" k8s/microservice.yaml
        
        # åº”ç”¨é…ç½®
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/secret.yaml
        kubectl apply -f k8s/postgres.yaml
        kubectl apply -f k8s/redis.yaml
        kubectl apply -f k8s/microservice.yaml
        
        # ç­‰å¾…éƒ¨ç½²å®Œæˆ
        kubectl rollout status deployment/microservice -n microservice --timeout=300s
```

### 2. ArgoCDé…ç½®

```yaml
# argocd/application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: microservice
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/your-org/microservice
    targetRevision: HEAD
    path: k8s
  destination:
    server: https://kubernetes.default.svc
    namespace: microservice
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
    - PrunePropagationPolicy=foreground
    - PruneLast=true
```

## ğŸ›¡ï¸ å®‰å…¨é…ç½®

### 1. ç½‘ç»œç­–ç•¥

```yaml
# k8s/network-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: microservice-netpol
  namespace: microservice
spec:
  podSelector:
    matchLabels:
      app: microservice
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: istio-system
    - podSelector:
        matchLabels:
          app: microservice
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  - to: []
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
```

### 2. Podå®‰å…¨ç­–ç•¥

```yaml
# k8s/pod-security-policy.yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: microservice-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
  - ALL
  volumes:
  - 'configMap'
  - 'emptyDir'
  - 'projected'
  - 'secret'
  - 'downwardAPI'
  - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. èµ„æºé™åˆ¶

```yaml
# k8s/hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: microservice-hpa
  namespace: microservice
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: microservice
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### 2. å‚ç›´Podè‡ªåŠ¨æ‰©ç¼©å®¹

```yaml
# k8s/vpa.yaml
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: microservice-vpa
  namespace: microservice
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: microservice
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
    - containerName: microservice
      minAllowed:
        cpu: 100m
        memory: 128Mi
      maxAllowed:
        cpu: 1000m
        memory: 1Gi
```

## ğŸ”§ è¿ç»´å·¥å…·

### 1. éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# scripts/deploy.sh

set -e

ENVIRONMENT="${1:-development}"
NAMESPACE="microservice"

echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° $ENVIRONMENT ç¯å¢ƒ..."

# 1. æ£€æŸ¥kubectlè¿æ¥
kubectl cluster-info

# 2. åº”ç”¨åŸºç¡€é…ç½®
kubectl apply -f k8s/namespace.yaml
kubectl apply -f k8s/configmap.yaml
kubectl apply -f k8s/secret.yaml

# 3. éƒ¨ç½²æ•°æ®åº“
kubectl apply -f k8s/postgres.yaml
kubectl apply -f k8s/redis.yaml

# 4. ç­‰å¾…æ•°æ®åº“å°±ç»ª
kubectl wait --for=condition=ready pod -l app=postgres -n $NAMESPACE --timeout=300s
kubectl wait --for=condition=ready pod -l app=redis -n $NAMESPACE --timeout=300s

# 5. éƒ¨ç½²åº”ç”¨
kubectl apply -f k8s/microservice.yaml

# 6. ç­‰å¾…åº”ç”¨å°±ç»ª
kubectl wait --for=condition=ready pod -l app=microservice -n $NAMESPACE --timeout=300s

# 7. åº”ç”¨æœåŠ¡ç½‘æ ¼é…ç½®
kubectl apply -f k8s/gateway.yaml
kubectl apply -f k8s/traffic-management.yaml

echo "âœ… éƒ¨ç½²å®Œæˆ"
```

### 2. å›æ»šè„šæœ¬

```bash
#!/bin/bash
# scripts/rollback.sh

set -e

NAMESPACE="microservice"
REVISION="${1:-previous}"

echo "ğŸ”„ å¼€å§‹å›æ»šåˆ° $REVISION ç‰ˆæœ¬..."

# å›æ»šéƒ¨ç½²
kubectl rollout undo deployment/microservice -n $NAMESPACE --to-revision=$REVISION

# ç­‰å¾…å›æ»šå®Œæˆ
kubectl rollout status deployment/microservice -n $NAMESPACE --timeout=300s

echo "âœ… å›æ»šå®Œæˆ"
```

## ğŸ“š æœ€ä½³å®è·µæ€»ç»“

### 1. éƒ¨ç½²åŸåˆ™

- **æ¸è¿›å¼éƒ¨ç½²**: ä½¿ç”¨è“ç»¿éƒ¨ç½²æˆ–é‡‘ä¸é›€å‘å¸ƒ
- **è‡ªåŠ¨åŒ–**: å®ç°å®Œå…¨è‡ªåŠ¨åŒ–çš„CI/CDæµæ°´çº¿
- **ç›‘æ§**: å»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»
- **å®‰å…¨**: å®æ–½å¤šå±‚å®‰å…¨é˜²æŠ¤

### 2. æ€§èƒ½ä¼˜åŒ–

- **èµ„æºç®¡ç†**: åˆç†é…ç½®èµ„æºè¯·æ±‚å’Œé™åˆ¶
- **è‡ªåŠ¨æ‰©ç¼©å®¹**: ä½¿ç”¨HPAå’ŒVPAå®ç°å¼¹æ€§ä¼¸ç¼©
- **ç¼“å­˜ç­–ç•¥**: åˆç†ä½¿ç”¨Redisç¼“å­˜
- **è¿æ¥æ± **: ä¼˜åŒ–æ•°æ®åº“è¿æ¥æ± é…ç½®

### 3. è¿ç»´ç®¡ç†

- **æ—¥å¿—èšåˆ**: ä½¿ç”¨ELK Stackæ”¶é›†å’Œåˆ†ææ—¥å¿—
- **æŒ‡æ ‡ç›‘æ§**: ä½¿ç”¨Prometheus + Grafanaç›‘æ§
- **åˆ†å¸ƒå¼è¿½è¸ª**: ä½¿ç”¨Jaegerè¿›è¡Œé“¾è·¯è¿½è¸ª
- **å¥åº·æ£€æŸ¥**: å®ç°å®Œå–„çš„å¥åº·æ£€æŸ¥æœºåˆ¶

### 4. å®‰å…¨æªæ–½

- **ç½‘ç»œéš”ç¦»**: ä½¿ç”¨NetworkPolicyé™åˆ¶ç½‘ç»œè®¿é—®
- **Podå®‰å…¨**: ä½¿ç”¨PodSecurityPolicyé™åˆ¶æƒé™
- **å¯†é’¥ç®¡ç†**: ä½¿ç”¨Kubernetes Secretç®¡ç†æ•æ„Ÿä¿¡æ¯
- **é•œåƒå®‰å…¨**: å®šæœŸæ‰«æé•œåƒå®‰å…¨æ¼æ´

## ğŸ”— ç›¸å…³èµ„æº

- [Kuberneteså®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/)
- [Istioå®˜æ–¹æ–‡æ¡£](https://istio.io/latest/docs/)
- [Prometheuså®˜æ–¹æ–‡æ¡£](https://prometheus.io/docs/)
- [Grafanaå®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/)
- [å¤šæ¡†æ¶é›†æˆæœ€ä½³å®è·µ](./å¤šæ¡†æ¶é›†æˆæœ€ä½³å®è·µ.md)

---

**æ³¨æ„**: æœ¬æ–‡æ¡£åŸºäº2025å¹´9æœˆçš„æœ€æ–°æŠ€æœ¯æ ˆï¼Œå»ºè®®å®šæœŸæ›´æ–°ä»¥ä¿æŒæ—¶æ•ˆæ€§ã€‚
