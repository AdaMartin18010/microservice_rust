# 10.2 Docker 容器化

## 10.2.1 多阶段构建

```Dockerfile
FROM rust:1.90 as builder
WORKDIR /app
COPY . .
RUN cargo build --release

FROM gcr.io/distroless/cc
COPY --from=builder /app/target/release/microservice-server /usr/bin/app
USER 65532:65532
ENTRYPOINT ["/usr/bin/app"]
```

## 10.2.2 最佳实践

- 最小基础镜像、只读根文件系统；
- 显式暴露端口与健康检查；
- SBOM 与镜像签名（cosign）。

## 10.2.3 SBOM/签名与策略联动

```bash
syft packages dir:. -o json > sbom.json
cosign sign ghcr.io/acme/microservice:TAG --yes
```

> 与 10.1 的准入策略（Kyverno/OPA）配合，仅允许已签名镜像进入集群；在 CI 中自动生成 SBOM 归档。

## 10.2.4 多架构镜像构建与拉取策略

```bash
docker buildx create --use
docker buildx build --platform linux/amd64,linux/arm64 -t ghcr.io/acme/microservice:TAG --push .
```

## 10.2.5 镜像拉取与签名策略（Kyverno 示例）

```yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-signed-images
spec:
  validationFailureAction: enforce
  rules:
    - name: verify-cosign-signature
      match:
        resources:
          kinds: [ Pod ]
      verifyImages:
        - imageReferences:
            - ghcr.io/acme/*
          attestors:
            - entries:
                - keys:
                    publicKeys: |
                      -----BEGIN PUBLIC KEY-----
                      MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE...
                      -----END PUBLIC KEY-----
```

K8s 拉取策略与镜像策略示例：

```yaml
apiVersion: apps/v1
kind: Deployment
spec:
  template:
    spec:
      imagePullSecrets: [ { name: ghcr-creds } ]
      containers:
      - name: app
        image: ghcr.io/acme/microservice:TAG
        imagePullPolicy: IfNotPresent
```
