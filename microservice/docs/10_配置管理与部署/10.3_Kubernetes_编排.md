# 10.3 Kubernetes 编排

## 10.3.1 清单建议

- Deployment：副本、资源请求/上限、探针与滚动升级；
- Service：ClusterIP/Headless；
- HPA：CPU/自定义指标扩缩；
- Ingress/网关：TLS、限流与策略。

## 10.3.2 进阶

- Operator/CRD 管理复杂有状态；
- Service Mesh（mTLS、金丝雀、熔断、重试）；
- Sidecar：日志/追踪/代理。

## 10.3.3 参考清单片段（可直接复用）

### Deployment（探针/资源/滚动升级）

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service
  labels: { app: user-service }
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate: { maxUnavailable: 0, maxSurge: 1 }
  selector:
    matchLabels: { app: user-service }
  template:
    metadata:
      labels: { app: user-service }
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9100"
    spec:
      containers:
      - name: app
        image: ghcr.io/acme/user-service:1.0.0
        ports: [{ containerPort: 8080 }]
        env:
        - name: RUST_LOG
          value: info
        resources:
          requests: { cpu: "200m", memory: "256Mi" }
          limits:   { cpu: "500m", memory: "512Mi" }
        readinessProbe:
          httpGet: { path: /health/ready, port: 8080 }
          initialDelaySeconds: 5
          periodSeconds: 5
        livenessProbe:
          httpGet: { path: /health/alive, port: 8080 }
          initialDelaySeconds: 10
          periodSeconds: 10
```

### Service 与 HPA

```yaml
apiVersion: v1
kind: Service
metadata:
  name: user-service
spec:
  selector: { app: user-service }
  ports:
    - name: http
      port: 80
      targetPort: 8080
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: user-service
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: user-service
  minReplicas: 3
  maxReplicas: 20
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
```

### Traefik IngressRoute（TLS/限流/金丝雀权重）

```yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: user-api
spec:
  entryPoints: [ websecure ]
  routes:
    - match: Host(`api.example.com`) && PathPrefix(`/user`)
      kind: Rule
      services:
        - name: user-service
          port: 80
          weight: 70
        - name: user-service-canary
          port: 80
          weight: 30
      middlewares:
        - name: user-ratelimit
  tls:
    certResolver: letsencrypt
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: user-ratelimit
spec:
  rateLimit:
    average: 100
    burst: 50
```

> 更细粒度金丝雀/回滚：可结合 Argo Rollouts（见下）。

### 渐进式交付（Argo Rollouts 金丝雀）

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: user-service
spec:
  replicas: 3
  strategy:
    canary:
      steps:
        - setWeight: 10
        - pause: { duration: 2m }
        - setWeight: 30
        - pause: { duration: 5m }
        - setWeight: 60
        - pause: {}
  selector:
    matchLabels: { app: user-service }
  template:
    metadata:
      labels: { app: user-service }
    spec:
      containers:
      - name: app
        image: ghcr.io/acme/user-service:1.1.0
        ports: [{ containerPort: 8080 }]
```

## 10.3.4 GitOps 建议

- 目录分层：`env/{staging,prod}/kustomization.yaml`；
- CI：构建/签名（cosign）并推送镜像与 Helm/Kustomize 清单；
- CD：Argo CD/Flux 监听 env 仓库；
- 保护策略：仅允许经 `policy-as-code` 审核的变更合入。
