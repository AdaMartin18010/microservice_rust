# 10.4 CI/CD 持续集成与部署

## 10.4.1 CI

- 缓存依赖与分层构建；
- lint/格式化/测试/安全扫描（audit/deny）；
- 基准与回归阈值。

## 10.4.2 CD

- 环境分层（dev/staging/prod）；
- GitOps（Argo CD/Flux）；
- 金丝雀/蓝绿发布与自动回滚。

## 10.4.3 GitHub Actions 工作流（Rust 1.90 + 安全 + 基准门禁）

```yaml
name: ci
on: { push: { branches: [ main ] }, pull_request: { branches: [ main ] } }
jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with: { toolchain: 1.90.0 }
      - uses: Swatinem/rust-cache@v2
      - run: cargo fmt --all -- --check
      - run: cargo clippy --all-targets -- -D warnings
      - run: cargo test --all --release
      - run: cargo audit || true
      - run: cargo deny check licenses bans sources advisories || true
  bench-guard:
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with: { toolchain: 1.90.0 }
      - run: scripts/run_benchmarks.sh | tee bench.txt
      - name: enforce P99
        run: scripts/verify_advancement.sh --p99-threshold 300 # ms
  build-image:
    runs-on: ubuntu-latest
    needs: [ build-test, bench-guard ]
    permissions: { id-token: write, contents: read }
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with: { registry: ghcr.io, username: ${{ github.actor }}, password: ${{ secrets.GITHUB_TOKEN }} }
      - uses: docker/build-push-action@v5
        with:
          push: true
          tags: ghcr.io/${{ github.repository }}/microservice:sha-${{ github.sha }}
      - name: cosign sign
        run: cosign sign ghcr.io/${{ github.repository }}/microservice:sha-${{ github.sha }} --yes
```

## 10.4.4 Argo CD 应用与渐进式交付联动

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: microservice-prod
spec:
  destination: { namespace: prod, server: https://kubernetes.default.svc }
  project: default
  source:
    repoURL: https://github.com/acme/env
    targetRevision: main
    path: env/prod
  syncPolicy:
    automated: { prune: true, selfHeal: true }
    syncOptions: [ CreateNamespace=true ]
```

与 Argo Rollouts 结合：当 CI 推送镜像与 Kustomize 更新后，Argo CD 同步 env 仓库，Rollouts 以设定步骤进行金丝雀，并根据 Prometheus/OTel 指标自动回滚。
