# 10.5 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ‰‹å†Œ

> å¾®æœåŠ¡ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„å®Œæ•´æŒ‡å—ï¼ŒåŒ…å«æœ€ä½³å®è·µå’Œæ•…éšœæ’é™¤

## ğŸ“‹ ç›®å½•

- [10.5 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ‰‹å†Œ](#105-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ‰‹å†Œ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [éƒ¨ç½²å‰å‡†å¤‡](#éƒ¨ç½²å‰å‡†å¤‡)
    - [1. ç¯å¢ƒæ£€æŸ¥æ¸…å•](#1-ç¯å¢ƒæ£€æŸ¥æ¸…å•)
      - [åŸºç¡€è®¾æ–½æ£€æŸ¥](#åŸºç¡€è®¾æ–½æ£€æŸ¥)
      - [åº”ç”¨é…ç½®æ£€æŸ¥](#åº”ç”¨é…ç½®æ£€æŸ¥)
    - [2. èµ„æºé…ç½®è¦æ±‚](#2-èµ„æºé…ç½®è¦æ±‚)
      - [æœ€å°èµ„æºè¦æ±‚](#æœ€å°èµ„æºè¦æ±‚)
      - [æ¨èèµ„æºé…ç½®](#æ¨èèµ„æºé…ç½®)
    - [3. å®‰å…¨é…ç½®](#3-å®‰å…¨é…ç½®)
      - [ç½‘ç»œå®‰å…¨é…ç½®](#ç½‘ç»œå®‰å…¨é…ç½®)
      - [å®‰å…¨ä¸Šä¸‹æ–‡é…ç½®](#å®‰å…¨ä¸Šä¸‹æ–‡é…ç½®)
  - [éƒ¨ç½²æµç¨‹](#éƒ¨ç½²æµç¨‹)
    - [1. å®¹å™¨åŒ–éƒ¨ç½²](#1-å®¹å™¨åŒ–éƒ¨ç½²)
      - [Dockerfileä¼˜åŒ–](#dockerfileä¼˜åŒ–)
      - [å®¹å™¨æ„å»ºè„šæœ¬](#å®¹å™¨æ„å»ºè„šæœ¬)
    - [2. Kuberneteséƒ¨ç½²](#2-kuberneteséƒ¨ç½²)
      - [éƒ¨ç½²æ¸…å•](#éƒ¨ç½²æ¸…å•)
    - [3. æœåŠ¡ç½‘æ ¼éƒ¨ç½²](#3-æœåŠ¡ç½‘æ ¼éƒ¨ç½²)
      - [Istioé…ç½®](#istioé…ç½®)
  - [ç›‘æ§ä¸å‘Šè­¦](#ç›‘æ§ä¸å‘Šè­¦)
    - [1. æŒ‡æ ‡ç›‘æ§](#1-æŒ‡æ ‡ç›‘æ§)
      - [Prometheusé…ç½®](#prometheusé…ç½®)
      - [å‘Šè­¦è§„åˆ™](#å‘Šè­¦è§„åˆ™)
    - [2. æ—¥å¿—èšåˆ](#2-æ—¥å¿—èšåˆ)
      - [Fluentdé…ç½®](#fluentdé…ç½®)
    - [3. åˆ†å¸ƒå¼è¿½è¸ª](#3-åˆ†å¸ƒå¼è¿½è¸ª)
      - [Jaegeré…ç½®](#jaegeré…ç½®)
  - [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
    - [1. å¸¸è§é—®é¢˜](#1-å¸¸è§é—®é¢˜)
      - [æœåŠ¡å¯åŠ¨å¤±è´¥](#æœåŠ¡å¯åŠ¨å¤±è´¥)
      - [æ€§èƒ½é—®é¢˜è¯Šæ–­](#æ€§èƒ½é—®é¢˜è¯Šæ–­)
    - [2. æ€§èƒ½è°ƒä¼˜](#2-æ€§èƒ½è°ƒä¼˜)
      - [æ•°æ®åº“ä¼˜åŒ–](#æ•°æ®åº“ä¼˜åŒ–)
      - [åº”ç”¨ä¼˜åŒ–](#åº”ç”¨ä¼˜åŒ–)
    - [3. å®‰å…¨äº‹ä»¶å¤„ç†](#3-å®‰å…¨äº‹ä»¶å¤„ç†)
      - [å®‰å…¨äº‹ä»¶å“åº”æµç¨‹](#å®‰å…¨äº‹ä»¶å“åº”æµç¨‹)
  - [ç»´æŠ¤æ“ä½œ](#ç»´æŠ¤æ“ä½œ)
    - [1. æ»šåŠ¨æ›´æ–°](#1-æ»šåŠ¨æ›´æ–°)
      - [æ›´æ–°è„šæœ¬](#æ›´æ–°è„šæœ¬)
    - [2. å›æ»šç­–ç•¥](#2-å›æ»šç­–ç•¥)
      - [å›æ»šè„šæœ¬](#å›æ»šè„šæœ¬)
    - [3. æ•°æ®å¤‡ä»½](#3-æ•°æ®å¤‡ä»½)
      - [å¤‡ä»½è„šæœ¬](#å¤‡ä»½è„šæœ¬)
  - [æ€»ç»“](#æ€»ç»“)

## éƒ¨ç½²å‰å‡†å¤‡

### 1. ç¯å¢ƒæ£€æŸ¥æ¸…å•

#### åŸºç¡€è®¾æ–½æ£€æŸ¥

```bash
#!/bin/bash
# ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥è„šæœ¬

echo "ğŸ” å¼€å§‹ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥..."

# æ£€æŸ¥ç³»ç»Ÿèµ„æº
echo "ğŸ“Š æ£€æŸ¥ç³»ç»Ÿèµ„æº..."
echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
echo "å†…å­˜æ€»é‡: $(free -h | grep '^Mem:' | awk '{print $2}')"
echo "ç£ç›˜ç©ºé—´: $(df -h / | tail -1 | awk '{print $4}')"

# æ£€æŸ¥ç½‘ç»œè¿æ¥
echo "ğŸŒ æ£€æŸ¥ç½‘ç»œè¿æ¥..."
ping -c 3 8.8.8.8 > /dev/null && echo "âœ… å¤–ç½‘è¿æ¥æ­£å¸¸" || echo "âŒ å¤–ç½‘è¿æ¥å¼‚å¸¸"
ping -c 3 kubernetes.default.svc.cluster.local > /dev/null && echo "âœ… é›†ç¾¤å†…ç½‘è¿æ¥æ­£å¸¸" || echo "âŒ é›†ç¾¤å†…ç½‘è¿æ¥å¼‚å¸¸"

# æ£€æŸ¥Docker
echo "ğŸ³ æ£€æŸ¥Docker..."
docker --version > /dev/null && echo "âœ… Dockerå·²å®‰è£…" || echo "âŒ Dockeræœªå®‰è£…"
docker info > /dev/null && echo "âœ… DockeræœåŠ¡æ­£å¸¸" || echo "âŒ DockeræœåŠ¡å¼‚å¸¸"

# æ£€æŸ¥Kubernetes
echo "â˜¸ï¸ æ£€æŸ¥Kubernetes..."
kubectl version --client > /dev/null && echo "âœ… kubectlå·²å®‰è£…" || echo "âŒ kubectlæœªå®‰è£…"
kubectl cluster-info > /dev/null && echo "âœ… Kubernetesé›†ç¾¤æ­£å¸¸" || echo "âŒ Kubernetesé›†ç¾¤å¼‚å¸¸"

# æ£€æŸ¥Helm
echo "â›µ æ£€æŸ¥Helm..."
helm version > /dev/null && echo "âœ… Helmå·²å®‰è£…" || echo "âŒ Helmæœªå®‰è£…"

# æ£€æŸ¥å­˜å‚¨
echo "ğŸ’¾ æ£€æŸ¥å­˜å‚¨..."
kubectl get storageclass > /dev/null && echo "âœ… å­˜å‚¨ç±»é…ç½®æ­£å¸¸" || echo "âŒ å­˜å‚¨ç±»é…ç½®å¼‚å¸¸"

echo "âœ… ç¯å¢ƒæ£€æŸ¥å®Œæˆ"
```

#### åº”ç”¨é…ç½®æ£€æŸ¥

```yaml
# ç”Ÿäº§ç¯å¢ƒé…ç½®æ¨¡æ¿
apiVersion: v1
kind: ConfigMap
metadata:
  name: microservice-config
  namespace: production
data:
  # åº”ç”¨é…ç½®
  APP_ENV: "production"
  LOG_LEVEL: "info"
  RUST_LOG: "info,microservice=debug"
  
  # æ•°æ®åº“é…ç½®
  DATABASE_URL: "postgresql://user:password@postgres-service:5432/microservice"
  DATABASE_MAX_CONNECTIONS: "50"
  DATABASE_MIN_CONNECTIONS: "10"
  DATABASE_CONNECTION_TIMEOUT: "30s"
  DATABASE_IDLE_TIMEOUT: "600s"
  
  # Redisé…ç½®
  REDIS_URL: "redis://redis-service:6379"
  REDIS_POOL_SIZE: "20"
  REDIS_TIMEOUT: "5s"
  
  # æœåŠ¡é…ç½®
  SERVICE_NAME: "microservice"
  SERVICE_VERSION: "1.0.0"
  SERVICE_PORT: "8080"
  SERVICE_HOST: "0.0.0.0"
  
  # ç›‘æ§é…ç½®
  METRICS_ENABLED: "true"
  METRICS_PORT: "9090"
  HEALTH_CHECK_INTERVAL: "30s"
  
  # å®‰å…¨é…ç½®
  JWT_SECRET: "your-production-secret-key"
  JWT_EXPIRY: "24h"
  TLS_ENABLED: "true"
  
  # æ€§èƒ½é…ç½®
  MAX_REQUEST_SIZE: "10MB"
  REQUEST_TIMEOUT: "30s"
  KEEP_ALIVE_TIMEOUT: "75s"
  WORKER_THREADS: "4"
```

### 2. èµ„æºé…ç½®è¦æ±‚

#### æœ€å°èµ„æºè¦æ±‚

| ç»„ä»¶ | CPU | å†…å­˜ | å­˜å‚¨ | ç½‘ç»œ |
|------|-----|------|------|------|
| å¾®æœåŠ¡å®ä¾‹ | 0.5æ ¸ | 512MB | 1GB | 100Mbps |
| PostgreSQL | 1æ ¸ | 2GB | 20GB | 100Mbps |
| Redis | 0.5æ ¸ | 1GB | 5GB | 100Mbps |
| ç›‘æ§ç»„ä»¶ | 1æ ¸ | 2GB | 10GB | 100Mbps |
| è´Ÿè½½å‡è¡¡å™¨ | 0.5æ ¸ | 512MB | 1GB | 1Gbps |

#### æ¨èèµ„æºé…ç½®

| ç»„ä»¶ | CPU | å†…å­˜ | å­˜å‚¨ | ç½‘ç»œ |
|------|-----|------|------|------|
| å¾®æœåŠ¡å®ä¾‹ | 2æ ¸ | 2GB | 5GB | 1Gbps |
| PostgreSQL | 4æ ¸ | 8GB | 100GB | 1Gbps |
| Redis | 2æ ¸ | 4GB | 20GB | 1Gbps |
| ç›‘æ§ç»„ä»¶ | 4æ ¸ | 8GB | 50GB | 1Gbps |
| è´Ÿè½½å‡è¡¡å™¨ | 2æ ¸ | 4GB | 10GB | 10Gbps |

### 3. å®‰å…¨é…ç½®

#### ç½‘ç»œå®‰å…¨é…ç½®

```yaml
# ç½‘ç»œç­–ç•¥é…ç½®
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: microservice-network-policy
  namespace: production
spec:
  podSelector:
    matchLabels:
      app: microservice
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: istio-system
    - podSelector:
        matchLabels:
          app: nginx-ingress
    ports:
    - protocol: TCP
      port: 8080
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
  - to: []
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
```

#### å®‰å…¨ä¸Šä¸‹æ–‡é…ç½®

```yaml
# Podå®‰å…¨ä¸Šä¸‹æ–‡
apiVersion: v1
kind: Pod
metadata:
  name: microservice-pod
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault
  containers:
  - name: microservice
    image: microservice:latest
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 1000
      capabilities:
        drop:
        - ALL
    resources:
      requests:
        memory: "512Mi"
        cpu: "500m"
      limits:
        memory: "1Gi"
        cpu: "1000m"
```

## éƒ¨ç½²æµç¨‹

### 1. å®¹å™¨åŒ–éƒ¨ç½²

#### Dockerfileä¼˜åŒ–

```dockerfile
# å¤šé˜¶æ®µæ„å»ºDockerfile
FROM rust:1.90-slim as builder

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶Cargoæ–‡ä»¶
COPY Cargo.toml Cargo.lock ./

# æ„å»ºä¾èµ–
RUN cargo build --release --locked

# å¤åˆ¶æºä»£ç 
COPY src ./src
COPY migrations ./migrations

# æ„å»ºåº”ç”¨
RUN cargo build --release --locked

# è¿è¡Œæ—¶é•œåƒ
FROM debian:bookworm-slim

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3 \
    libpq5 \
    && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r microservice && useradd -r -g microservice microservice

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /app/target/release/microservice /app/microservice
COPY --from=builder /app/migrations /app/migrations

# è®¾ç½®æƒé™
RUN chown -R microservice:microservice /app
USER microservice

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¯åŠ¨å‘½ä»¤
CMD ["./microservice"]
```

#### å®¹å™¨æ„å»ºè„šæœ¬

```bash
#!/bin/bash
# å®¹å™¨æ„å»ºå’Œæ¨é€è„šæœ¬

set -e

# é…ç½®å˜é‡
REGISTRY="your-registry.com"
IMAGE_NAME="microservice"
VERSION=${1:-latest}
NAMESPACE="production"

echo "ğŸ—ï¸ å¼€å§‹æ„å»ºå®¹å™¨é•œåƒ..."

# æ„å»ºé•œåƒ
docker build -t ${REGISTRY}/${IMAGE_NAME}:${VERSION} .
docker build -t ${REGISTRY}/${IMAGE_NAME}:latest .

echo "âœ… é•œåƒæ„å»ºå®Œæˆ"

# è¿è¡Œå®‰å…¨æ‰«æ
echo "ğŸ” è¿è¡Œå®‰å…¨æ‰«æ..."
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
    aquasec/trivy image ${REGISTRY}/${IMAGE_NAME}:${VERSION}

# æ¨é€é•œåƒ
echo "ğŸ“¤ æ¨é€é•œåƒåˆ°ä»“åº“..."
docker push ${REGISTRY}/${IMAGE_NAME}:${VERSION}
docker push ${REGISTRY}/${IMAGE_NAME}:latest

echo "âœ… é•œåƒæ¨é€å®Œæˆ"

# æ›´æ–°Kuberneteséƒ¨ç½²
echo "ğŸš€ æ›´æ–°Kuberneteséƒ¨ç½²..."
kubectl set image deployment/microservice \
    microservice=${REGISTRY}/${IMAGE_NAME}:${VERSION} \
    -n ${NAMESPACE}

echo "âœ… éƒ¨ç½²æ›´æ–°å®Œæˆ"
```

### 2. Kuberneteséƒ¨ç½²

#### éƒ¨ç½²æ¸…å•

```yaml
# å®Œæ•´çš„Kuberneteséƒ¨ç½²æ¸…å•
apiVersion: apps/v1
kind: Deployment
metadata:
  name: microservice
  namespace: production
  labels:
    app: microservice
    version: v1
spec:
  replicas: 3
  selector:
    matchLabels:
      app: microservice
  template:
    metadata:
      labels:
        app: microservice
        version: v1
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: microservice
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
      - name: microservice
        image: your-registry.com/microservice:latest
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 9090
          name: metrics
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: database-secret
              key: url
        - name: REDIS_URL
          valueFrom:
            configMapKeyRef:
              name: microservice-config
              key: REDIS_URL
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: jwt-secret
              key: secret
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: migrations
          mountPath: /app/migrations
          readOnly: true
      volumes:
      - name: tmp
        emptyDir: {}
      - name: migrations
        configMap:
          name: migrations-config
      imagePullSecrets:
      - name: registry-secret
      nodeSelector:
        kubernetes.io/os: linux
      tolerations:
      - key: "node-role.kubernetes.io/master"
        operator: "Exists"
        effect: "NoSchedule"
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - microservice
              topologyKey: kubernetes.io/hostname
---
apiVersion: v1
kind: Service
metadata:
  name: microservice-service
  namespace: production
  labels:
    app: microservice
spec:
  selector:
    app: microservice
  ports:
  - name: http
    port: 80
    targetPort: 8080
    protocol: TCP
  - name: metrics
    port: 9090
    targetPort: 9090
    protocol: TCP
  type: ClusterIP
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: microservice-hpa
  namespace: production
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: microservice
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
```

### 3. æœåŠ¡ç½‘æ ¼éƒ¨ç½²

#### Istioé…ç½®

```yaml
# Istio Gatewayé…ç½®
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: microservice-gateway
  namespace: production
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - microservice.your-domain.com
    tls:
      httpsRedirect: true
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - microservice.your-domain.com
    tls:
      mode: SIMPLE
      credentialName: microservice-tls
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: microservice-vs
  namespace: production
spec:
  hosts:
  - microservice.your-domain.com
  gateways:
  - microservice-gateway
  http:
  - match:
    - headers:
        version:
          exact: v2
    route:
    - destination:
        host: microservice-service
        subset: v2
      weight: 100
  - route:
    - destination:
        host: microservice-service
        subset: v1
      weight: 90
    - destination:
        host: microservice-service
        subset: v2
      weight: 10
    fault:
      delay:
        percentage:
          value: 0.1
        fixedDelay: 5s
    retries:
      attempts: 3
      perTryTimeout: 2s
      retryOn: 5xx,reset,connect-failure,refused-stream
    timeout: 30s
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: microservice-dr
  namespace: production
spec:
  host: microservice-service
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        maxRequestsPerConnection: 10
        maxRetries: 3
        consecutiveGatewayErrors: 5
        interval: 30s
        baseEjectionTime: 30s
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

## ç›‘æ§ä¸å‘Šè­¦

### 1. æŒ‡æ ‡ç›‘æ§

#### Prometheusé…ç½®

```yaml
# Prometheusé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    rule_files:
      - "alert_rules.yml"
    
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093
    
    scrape_configs:
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name
      
      - job_name: 'microservice'
        static_configs:
          - targets: ['microservice-service:9090']
        metrics_path: /metrics
        scrape_interval: 10s
```

#### å‘Šè­¦è§„åˆ™

```yaml
# å‘Šè­¦è§„åˆ™é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: alert-rules
  namespace: monitoring
data:
  alert_rules.yml: |
    groups:
    - name: microservice
      rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is above 5% for 5 minutes"
      
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency detected"
          description: "95th percentile latency is above 1 second"
      
      - alert: ServiceDown
        expr: up{job="microservice"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service is down"
          description: "Microservice is not responding"
      
      - alert: HighMemoryUsage
        expr: (container_memory_usage_bytes / container_spec_memory_limit_bytes) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is above 80%"
      
      - alert: HighCPUUsage
        expr: (rate(container_cpu_usage_seconds_total[5m]) / container_spec_cpu_quota) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is above 80%"
```

### 2. æ—¥å¿—èšåˆ

#### Fluentdé…ç½®

```yaml
# Fluentdé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: logging
data:
  fluent.conf: |
    <source>
      @type tail
      path /var/log/containers/*microservice*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      format json
      time_key time
      time_format %Y-%m-%dT%H:%M:%S.%NZ
    </source>
    
    <filter kubernetes.**>
      @type kubernetes_metadata
    </filter>
    
    <filter kubernetes.**>
      @type parser
      key_name log
      reserve_data true
      <parse>
        @type json
      </parse>
    </filter>
    
    <match kubernetes.**>
      @type elasticsearch
      host elasticsearch.logging.svc.cluster.local
      port 9200
      index_name microservice-logs
      type_name _doc
      include_tag_key true
      tag_key @log_name
      flush_interval 1s
    </match>
```

### 3. åˆ†å¸ƒå¼è¿½è¸ª

#### Jaegeré…ç½®

```yaml
# Jaegeré…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: jaeger-config
  namespace: tracing
data:
  jaeger.yaml: |
    collector:
      grpc:
        host-port: ":14250"
      http:
        host-port: ":14268"
      zipkin:
        host-port: ":9411"
    
    query:
      base-path: /jaeger
    
    agent:
      grpc:
        host-port: ":14250"
      http:
        host-port: ":14268"
      zipkin:
        host-port: ":9411"
    
    storage:
      type: elasticsearch
      elasticsearch:
        server-urls: http://elasticsearch.logging.svc.cluster.local:9200
        index-prefix: jaeger
        tags-as-fields:
          all: true
```

## æ•…éšœæ’é™¤

### 1. å¸¸è§é—®é¢˜

#### æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
#!/bin/bash
# æœåŠ¡å¯åŠ¨æ•…éšœæ’é™¤è„šæœ¬

echo "ğŸ” æ£€æŸ¥æœåŠ¡å¯åŠ¨çŠ¶æ€..."

# æ£€æŸ¥PodçŠ¶æ€
kubectl get pods -n production -l app=microservice

# æ£€æŸ¥Podæ—¥å¿—
kubectl logs -n production -l app=microservice --tail=100

# æ£€æŸ¥äº‹ä»¶
kubectl get events -n production --sort-by='.lastTimestamp'

# æ£€æŸ¥é…ç½®
kubectl describe configmap microservice-config -n production

# æ£€æŸ¥å¯†é’¥
kubectl describe secret database-secret -n production

# æ£€æŸ¥æœåŠ¡
kubectl get svc -n production

# æ£€æŸ¥ç«¯ç‚¹
kubectl get endpoints -n production

echo "âœ… æ•…éšœæ’é™¤å®Œæˆ"
```

#### æ€§èƒ½é—®é¢˜è¯Šæ–­

```bash
#!/bin/bash
# æ€§èƒ½é—®é¢˜è¯Šæ–­è„šæœ¬

echo "ğŸ” å¼€å§‹æ€§èƒ½è¯Šæ–­..."

# æ£€æŸ¥èµ„æºä½¿ç”¨æƒ…å†µ
kubectl top pods -n production
kubectl top nodes

# æ£€æŸ¥HPAçŠ¶æ€
kubectl get hpa -n production

# æ£€æŸ¥ç½‘ç»œç­–ç•¥
kubectl get networkpolicies -n production

# æ£€æŸ¥æœåŠ¡ç½‘æ ¼é…ç½®
kubectl get virtualservice -n production
kubectl get destinationrule -n production

# æ£€æŸ¥ç›‘æ§æŒ‡æ ‡
kubectl port-forward -n monitoring svc/prometheus 9090:9090 &
sleep 5
curl -s "http://localhost:9090/api/v1/query?query=up" | jq

echo "âœ… æ€§èƒ½è¯Šæ–­å®Œæˆ"
```

### 2. æ€§èƒ½è°ƒä¼˜

#### æ•°æ®åº“ä¼˜åŒ–

```sql
-- PostgreSQLæ€§èƒ½ä¼˜åŒ–é…ç½®
-- è¿æ¥æ± é…ç½®
ALTER SYSTEM SET max_connections = 200;
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
ALTER SYSTEM SET checkpoint_completion_target = 0.9;
ALTER SYSTEM SET wal_buffers = '16MB';
ALTER SYSTEM SET default_statistics_target = 100;

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX CONCURRENTLY idx_orders_user_id ON orders(user_id);
CREATE INDEX CONCURRENTLY idx_orders_created_at ON orders(created_at);
CREATE INDEX CONCURRENTLY idx_payments_order_id ON payments(order_id);

-- æŸ¥è¯¢ä¼˜åŒ–
EXPLAIN ANALYZE SELECT * FROM orders WHERE user_id = $1 AND created_at > $2;
```

#### åº”ç”¨ä¼˜åŒ–

```rust
// åº”ç”¨æ€§èƒ½ä¼˜åŒ–é…ç½®
use tokio::runtime::Runtime;
use std::sync::Arc;

pub struct OptimizedApp {
    runtime: Arc<Runtime>,
    db_pool: sqlx::PgPool,
    redis_pool: redis::Pool,
}

impl OptimizedApp {
    pub fn new() -> Self {
        // åˆ›å»ºä¼˜åŒ–çš„è¿è¡Œæ—¶
        let runtime = Arc::new(Runtime::new().unwrap());
        
        // é…ç½®æ•°æ®åº“è¿æ¥æ± 
        let db_pool = runtime.block_on(async {
            sqlx::PgPool::builder()
                .max_connections(50)
                .min_connections(10)
                .acquire_timeout(Duration::from_secs(30))
                .idle_timeout(Duration::from_secs(600))
                .build("postgresql://...")
                .await
                .unwrap()
        });
        
        // é…ç½®Redisè¿æ¥æ± 
        let redis_pool = redis::Pool::builder()
            .max_size(20)
            .min_idle(Some(5))
            .connection_timeout(Duration::from_secs(5))
            .build("redis://...")
            .unwrap();
        
        Self {
            runtime,
            db_pool,
            redis_pool,
        }
    }
}
```

### 3. å®‰å…¨äº‹ä»¶å¤„ç†

#### å®‰å…¨äº‹ä»¶å“åº”æµç¨‹

```bash
#!/bin/bash
# å®‰å…¨äº‹ä»¶å“åº”è„šæœ¬

echo "ğŸš¨ å®‰å…¨äº‹ä»¶å“åº”å¼€å§‹..."

# 1. éš”ç¦»å—å½±å“çš„Pod
kubectl get pods -n production -l app=microservice
kubectl delete pod <affected-pod> -n production

# 2. æ£€æŸ¥æ—¥å¿—
kubectl logs -n production -l app=microservice --since=1h | grep -i "error\|exception\|attack"

# 3. æ£€æŸ¥ç½‘ç»œæµé‡
kubectl exec -n production <pod-name> -- netstat -tulpn

# 4. æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ
kubectl exec -n production <pod-name> -- find /app -type f -newer /app/microservice

# 5. æ›´æ–°å®‰å…¨ç­–ç•¥
kubectl apply -f security-policy.yaml

# 6. é€šçŸ¥å®‰å…¨å›¢é˜Ÿ
echo "å®‰å…¨äº‹ä»¶å·²æŠ¥å‘Šç»™å®‰å…¨å›¢é˜Ÿ"

echo "âœ… å®‰å…¨äº‹ä»¶å“åº”å®Œæˆ"
```

## ç»´æŠ¤æ“ä½œ

### 1. æ»šåŠ¨æ›´æ–°

#### æ›´æ–°è„šæœ¬

```bash
#!/bin/bash
# æ»šåŠ¨æ›´æ–°è„šæœ¬

set -e

VERSION=${1:-latest}
NAMESPACE="production"
DEPLOYMENT="microservice"

echo "ğŸš€ å¼€å§‹æ»šåŠ¨æ›´æ–°åˆ°ç‰ˆæœ¬: $VERSION"

# æ£€æŸ¥å½“å‰çŠ¶æ€
kubectl get deployment $DEPLOYMENT -n $NAMESPACE

# æ‰§è¡Œæ»šåŠ¨æ›´æ–°
kubectl set image deployment/$DEPLOYMENT \
    microservice=your-registry.com/microservice:$VERSION \
    -n $NAMESPACE

# ç­‰å¾…æ›´æ–°å®Œæˆ
kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=300s

# éªŒè¯æ›´æ–°
kubectl get pods -n $NAMESPACE -l app=microservice
kubectl get deployment $DEPLOYMENT -n $NAMESPACE

echo "âœ… æ»šåŠ¨æ›´æ–°å®Œæˆ"
```

### 2. å›æ»šç­–ç•¥

#### å›æ»šè„šæœ¬

```bash
#!/bin/bash
# å›æ»šè„šæœ¬

set -e

NAMESPACE="production"
DEPLOYMENT="microservice"
REVISION=${1:-""}

echo "ğŸ”„ å¼€å§‹å›æ»šæ“ä½œ..."

# æŸ¥çœ‹å›æ»šå†å²
kubectl rollout history deployment/$DEPLOYMENT -n $NAMESPACE

if [ -z "$REVISION" ]; then
    # å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
    kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE
else
    # å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
    kubectl rollout undo deployment/$DEPLOYMENT --to-revision=$REVISION -n $NAMESPACE
fi

# ç­‰å¾…å›æ»šå®Œæˆ
kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=300s

# éªŒè¯å›æ»š
kubectl get pods -n $NAMESPACE -l app=microservice
kubectl get deployment $DEPLOYMENT -n $NAMESPACE

echo "âœ… å›æ»šå®Œæˆ"
```

### 3. æ•°æ®å¤‡ä»½

#### å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# æ•°æ®å¤‡ä»½è„šæœ¬

set -e

BACKUP_DIR="/backup/$(date +%Y%m%d_%H%M%S)"
NAMESPACE="production"

echo "ğŸ’¾ å¼€å§‹æ•°æ®å¤‡ä»½..."

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½PostgreSQL
kubectl exec -n $NAMESPACE postgres-0 -- pg_dump -U postgres microservice > $BACKUP_DIR/postgres_backup.sql

# å¤‡ä»½Redis
kubectl exec -n $NAMESPACE redis-0 -- redis-cli BGSAVE
kubectl cp $NAMESPACE/redis-0:/data/dump.rdb $BACKUP_DIR/redis_backup.rdb

# å¤‡ä»½é…ç½®æ–‡ä»¶
kubectl get configmap -n $NAMESPACE -o yaml > $BACKUP_DIR/configmaps.yaml
kubectl get secret -n $NAMESPACE -o yaml > $BACKUP_DIR/secrets.yaml

# å¤‡ä»½Kubernetesèµ„æº
kubectl get all -n $NAMESPACE -o yaml > $BACKUP_DIR/resources.yaml

# å‹ç¼©å¤‡ä»½
tar -czf $BACKUP_DIR.tar.gz $BACKUP_DIR
rm -rf $BACKUP_DIR

echo "âœ… æ•°æ®å¤‡ä»½å®Œæˆ: $BACKUP_DIR.tar.gz"
```

## æ€»ç»“

æœ¬ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ‰‹å†Œæä¾›äº†å®Œæ•´çš„éƒ¨ç½²ã€ç›‘æ§ã€æ•…éšœæ’é™¤å’Œç»´æŠ¤æŒ‡å—ï¼š

1. **éƒ¨ç½²å‰å‡†å¤‡**ï¼šç¯å¢ƒæ£€æŸ¥ã€èµ„æºé…ç½®ã€å®‰å…¨é…ç½®
2. **éƒ¨ç½²æµç¨‹**ï¼šå®¹å™¨åŒ–ã€Kubernetesã€æœåŠ¡ç½‘æ ¼éƒ¨ç½²
3. **ç›‘æ§ä¸å‘Šè­¦**ï¼šæŒ‡æ ‡ç›‘æ§ã€æ—¥å¿—èšåˆã€åˆ†å¸ƒå¼è¿½è¸ª
4. **æ•…éšœæ’é™¤**ï¼šå¸¸è§é—®é¢˜ã€æ€§èƒ½è°ƒä¼˜ã€å®‰å…¨äº‹ä»¶å¤„ç†
5. **ç»´æŠ¤æ“ä½œ**ï¼šæ»šåŠ¨æ›´æ–°ã€å›æ»šç­–ç•¥ã€æ•°æ®å¤‡ä»½

é€šè¿‡éµå¾ªæœ¬æ‰‹å†Œï¼Œå¯ä»¥ç¡®ä¿å¾®æœåŠ¡åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„ç¨³å®šè¿è¡Œå’Œé«˜æ•ˆç»´æŠ¤ã€‚
