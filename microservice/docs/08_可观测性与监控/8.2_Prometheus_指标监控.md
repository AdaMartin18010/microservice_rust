# 8.2 Prometheus 指标监控

Prometheus 提供时序指标抓取与告警，适合服务健康、SLO/SLA 与容量管理。

## 8.2.1 Rust 集成

- `prometheus`/`metrics`/`metrics-exporter-prometheus`；
- 指标类型：Counter/Gauge/Histogram/Summary；
- 标签规范：service、endpoint、status、env、zone。

## 8.2.2 建议

- 定义 RED/USE 指标体系；
- 配置抓取与重标记；
- 告警规则与抑制策略。

## 8.2.3 告警规则（PrometheusRule 片段）

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: microservice-alerts
spec:
  groups:
  - name: service.slo
    rules:
    - alert: HighErrorRate
      expr: sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) > 0.01
      for: 10m
      labels: { severity: critical, slo: error-rate }
      annotations:
        summary: 
          高错误率
        description: >
          近10分钟5xx比例超过1%
    - alert: HighLatencyP99
      expr: histogram_quantile(0.99, sum(rate(http_server_duration_bucket[5m])) by (le)) > 0.3
      for: 10m
      labels: { severity: warning, slo: latency }
      annotations:
        summary: P99 延迟过高
        description: P99 延迟超过 300ms
  - name: runtime.capacity
    rules:
    - alert: HighCPU
      expr: sum(rate(container_cpu_usage_seconds_total{image!=""}[5m])) by (pod) / on(pod) group_left kube_pod_container_resource_limits{resource="cpu"} > 0.8
      for: 15m
      labels: { severity: warning }
      annotations:
        summary: CPU 高使用率
        description: 容器 CPU 使用率超过 80%
```

> 配合 14.10 的 SLO 基线设置阈值；与 Grafana Dashboard 的阈值保持一致，避免认知偏差。

## 8.2.4 Burn Rate（短/长窗口）告警

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: slo-burnrate
spec:
  groups:
  - name: slo.http
    rules:
    # SLO 99.9% 示例（误差预算 0.1%）
    - alert: SLOBurnRateHighShort
      expr: (sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) / 0.001 > 14
      for: 5m
      labels: { severity: critical, window: short }
      annotations:
        summary: SLO Burn Rate 高（短窗口）
        description: 5m 窗口内错误预算消耗率过高
    - alert: SLOBurnRateHighLong
      expr: (sum(rate(http_requests_total{status=~"5.."}[1h])) / sum(rate(http_requests_total[1h]))) / 0.001 > 7
      for: 1h
      labels: { severity: critical, window: long }
      annotations:
        summary: SLO Burn Rate 高（长窗口）
        description: 1h 窗口内错误预算消耗率过高
```
