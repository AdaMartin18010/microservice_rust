# 8.1 OpenTelemetry 可观测性

OpenTelemetry（OTel）提供统一的 Traces/Metrics/Logs 规范与 SDK，适合在多语言微服务中构建一致观测面。

## 8.1.1 Rust 集成要点

- 使用 `opentelemetry`、`tracing`、`tracing-opentelemetry`；
- 导出器：OTLP/HTTP/GRPC，接入 Collector；
- 语义约定：HTTP、RPC、DB、消息队列等标准标签。

## 8.1.2 最小集成（示意）

```rust
let tracer = opentelemetry_otlp::new_pipeline()
    .tracing()
    .with_exporter(opentelemetry_otlp::new_exporter().tonic())
    .install_batch(opentelemetry::runtime::Tokio)?;

let _sub = tracing_subscriber::registry()
    .with(tracing_opentelemetry::layer().with_tracer(tracer))
    .with(tracing_subscriber::fmt::layer())
    .init();
```

## 8.1.3 最佳实践

- TraceID 通过网关注入并全链路透传；
- 统一资源属性（service.name、version、env、zone）；
- 结合采样率与慢调用阈值，控制成本与信噪比。

## 8.1.4 Collector 部署（Helm / Operator 模板）

```bash
# Helm（otel/opentelemetry-helm-charts）
helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
helm upgrade --install otel-collector open-telemetry/opentelemetry-collector \
  -n observability --create-namespace \
  --set mode=deployment \
  --set presets.logsCollection.enabled=true \
  --set presets.kubernetesAttributes.enabled=true
```

```yaml
# Operator（OpenTelemetry Operator）- 最小示例
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: otel
  namespace: observability
spec:
  mode: deployment
  config: |
    receivers:
      otlp:
        protocols: { http: {}, grpc: {} }
    processors:
      batch: {}
    exporters:
      prometheus: { endpoint: 0.0.0.0:9464 }
      otlp:
        endpoint: tempo:4317
        tls: { insecure: true }
    service:
      pipelines:
        metrics: { receivers: [otlp], processors: [batch], exporters: [prometheus] }
        traces:  { receivers: [otlp], processors: [batch], exporters: [otlp] }
```

## 8.1.5 后端组合（Prometheus + Tempo/Jaeger + Loki + Grafana）

- 指标：Prometheus（抓取 Collector `:9464`），仪表盘导入 `Node/Pod/Service` 与 HTTP/gRPC 模板；
- 追踪：Tempo（原生 OTLP）或 Jaeger；Grafana 统一可视化；
- 日志：Loki，关联 TraceID，Grafana 中串联 Logs↔Traces。

## 8.1.6 仪表盘与告警模板

- Dashboard：HTTP 概览（QPS、P95/P99、错误率）、gRPC 概览、Kafka/NATS 消费延迟；
- 告警：基于错误预算的 SLO（如 99.9%/30天），高错误率/高延迟/无流量。

## 8.1.7 采样与成本控制

- 动态采样：按服务/端点/错误分类；
- 优先保留错误与慢调用；对热路径按比例采样；
- 网关/边缘上移采样，减少核心链路压力。

## 8.1.8 与 14 章蓝图对齐

- 14.1/14.2：入口/内部统一 OTLP；
- 14.3：事件消费链路打点，观测滞留/重放；
- 14.4：边缘上移采样与汇聚；
- 14.5：Mesh 遥测与应用埋点并存时避免重复与冲突。

## 8.1.9 Grafana 仪表盘导入

- 模板文件：`docs/08_可观测性与监控/grafana_dashboards/otlp_http_grpc_overview.json`
- 导入方式：Grafana → Dashboards → New → Import → 上传 JSON；
- 数据源：Prometheus（指标），Tempo/Jaeger（追踪），Loki（日志）。
