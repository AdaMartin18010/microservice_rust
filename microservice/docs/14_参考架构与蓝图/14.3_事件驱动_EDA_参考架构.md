# 14.3 事件驱动（EDA）参考架构

- 事件总线：Kafka（主），可选 Pulsar/NATS JetStream
- 模式：Outbox + Debezium CDC；Saga（编排/舞蹈）与 TCC
- 存储：OLTP（PostgreSQL）+ OLAP（ClickHouse）分层
- 模型：事件模式与 schema registry；幂等与去重键
- 观测：端到端 trace 贯穿生产-消费；滞留/重放指标

## 关键落地点

- Outbox：事务写入本地表 → CDC 推送 Kafka，避免二阶段提交
- 消费者：幂等处理，exactly-once 通过去重表/幂等键近似实现
- Rust 1.90：异步流（GAT）批量消费；背压/速率限制；零拷贝 Bytes

## 最小可行组合（MVP）

Kafka + Debezium + PostgreSQL + ClickHouse（可选）+ OTel + Kubernetes

## 最小配置模板（片段）

```yaml
# docker-compose.debezium.yml（片段）
version: '3.8'
services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    environment: { ZOOKEEPER_CLIENT_PORT: 2181 }
  kafka:
    image: confluentinc/cp-kafka:7.6.1
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
    depends_on: [zookeeper]
  connect:
    image: debezium/connect:2.7
    environment:
      BOOTSTRAP_SERVERS: kafka:9092
      GROUP_ID: 1
      CONFIG_STORAGE_TOPIC: connect-configs
      OFFSET_STORAGE_TOPIC: connect-offsets
      STATUS_STORAGE_TOPIC: connect-status
    depends_on: [kafka]
```

- 示例：`examples/messaging_demo.rs`/`examples/messaging_advanced_demo.rs` 对应生产/消费与重试/幂等处理。
