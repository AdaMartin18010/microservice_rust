# 14.2 企业内部 RPC 参考架构

- 协议/框架：gRPC（HTTP/2）+ tonic，或混合引入 Volo（多语言/性能）
- 注册与发现：etcd/Consul；配置：GitOps + 配置中心
- 数据：PostgreSQL/ClickHouse；缓存：Redis；对象存储：S3 兼容
- 消息：Kafka 事务性 outbox；事件溯源（可选）
- 网关：Traefik（mTLS 透传）；安全：mTLS + SPIFFE/SPIRE + RBAC
- 观测：OTel（traces/metrics/logs 统一）+ Grafana/Loki/Tempo
- 部署：Kubernetes + HPA + PDB + 金丝雀/蓝绿发布

## 关键落地点

- IDL 管理：proto 模型版本化；向后兼容的字段演进策略
- 可靠性：超时/重试/熔断/负载均衡；连接池与 backoff
- Rust 1.90：异步服务 trait 复用到 tonic Service；GAT 流式响应

## 最小可行组合（MVP）

tonic + etcd + Kafka + Traefik + OTel + Kubernetes

## 最小配置模板（片段）

```yaml
# k8s/deploy-grpc-service.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-grpc
spec:
  replicas: 2
  selector:
    matchLabels: { app: user-grpc }
  template:
    metadata:
      labels: { app: user-grpc }
    spec:
      containers:
        - name: server
          image: ghcr.io/org/user-grpc:latest
          ports:
            - containerPort: 50051
          env:
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: http://otel-collector:4317
          # mTLS 可通过 sidecar（Istio/Linkerd）或应用层 TLS（见章节 3.3.8）
---
apiVersion: v1
kind: Service
metadata:
  name: user-grpc
spec:
  selector: { app: user-grpc }
  ports:
    - name: grpc
      port: 50051
      targetPort: 50051
```

```yaml
# k8s/traefik-tcp-route.yaml（TCP 路由直通 gRPC）
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRouteTCP
metadata:
  name: grpc-route
spec:
  entryPoints:
    - grpc
  routes:
    - match: HostSNI(`*`)
      services:
        - name: user-grpc
          port: 50051
```
