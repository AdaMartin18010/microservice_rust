# 14.1 互联网 API 参考架构

- 协议/框架：HTTP/1.1 + HTTP/2，axum/hyper
- 业务组织：DDD 分层（domain/app/infra）与 handler-服务编排
- 数据：PostgreSQL + SQLx；缓存：Redis；搜索：Meilisearch（可选）
- 消息：Kafka（业务事件/审计日志）；异步任务：NATS JetStream（可选）
- 网关：Kong 或 Traefik；安全：JWT/OIDC + mTLS 内部通道
- 观测：OpenTelemetry + Prometheus + Jaeger/Tempo + Grafana
- 部署：Docker + Kubernetes（HPA、PodDisruptionBudget、优雅停止）

## 关键落地点

- Rust 1.90：稳定异步 trait + GAT 推动零拷贝管道（参考 2.2）
- API 版本化与幂等：幂等键、请求去重、幂等错误码约定
- 背压：并发限流/令牌桶、超时与熔断、重试带抖动
- 指标：QPS/错误率/延迟 P50/P95/P99；采样率分级；结构化日志

## 最小可行组合（MVP）

axum + SQLx + Redis + Kafka + Traefik + OpenTelemetry + Kubernetes

## 最小配置模板（片段）

```yaml
# k8s/ingress-traefik.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api-gateway
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
spec:
  tls:
    - hosts: ["api.example.com"]
  rules:
    - host: api.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: user-service
                port:
                  number: 3000
```

```yaml
# k8s/otel-collector.yaml（最小）
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-conf
  namespace: observability
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
          http:
    exporters:
      prometheus:
        endpoint: 0.0.0.0:9464
      otlp:
        endpoint: tempo:4317
        tls:
          insecure: true
    service:
      pipelines:
        metrics:
          receivers: [otlp]
          exporters: [prometheus]
        traces:
          receivers: [otlp]
          exporters: [otlp]
```
