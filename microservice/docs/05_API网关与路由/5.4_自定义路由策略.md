# 5.4 自定义路由策略

在统一网关之外，可在 Rust 服务内实现细粒度路由与灰度策略：

## 5.4.1 策略类型

- 按用户/租户/版本/地域/可用区；
- 灰度发布（金丝雀/按百分比/按标签）；
- 故障转移与回退策略。

## 5.4.2 工程落地

- 策略配置中心化并支持热更新；
- 结合追踪上下文进行一致性路由（sticky）；
- 将决定记录为事件，便于审计和回放。

## 5.4.3 与网关/服务发现协同

- 与 `Traefik/Kong` 配合：入口做粗粒度分流，服务内做细粒度策略与快速回退。
- 与服务发现协同：基于 `Consul/etcd/Nacos` 标签与健康状态选择候选实例。
- 与熔断/限流协同：在路由前后插入 `tower` 的超时、重试、熔断、速率限制。

## 5.4.4 Rust 1.90 语言特性加持

- 异步 trait 稳定化：策略接口天然异步，便于并发查询配置与指标。
- GAT/TAIT：在 `tower::Service` 组合中返回零拷贝迭代器/流式响应，降低开销。
- 更佳的 `Send/Sync` 推断：中间件栈组合更简单、类型更安全。

## 5.4.5 参考实现要点（Axum/tower）

- 策略载入：本地缓存 + 后台异步刷新（ETag/版本号比对）。
- 决策输入：请求头、Cookie、JWT 声明、Trace 上下文（如 `baggage`）、客户端 IP 与地理信息。
- 决策算法：
  - 一致性哈希（用户/租户维度粘滞）；
  - 百分比分流（稳定伪随机：用户ID + 实验ID 哈希到 [0,100)）；
  - 标签选择器（版本、地区、机房、实例权重）。
- 可观测性：将“路由决策”作为事件打点（指标 + 结构化日志 + 追踪属性）。
- 失败处理：候选实例为空时回退至稳定版本或最近健康集；超时触发次级策略。

示例：一致性哈希分桶（伪代码）

```rust
fn pick_bucket(user_key: &str, experiment: &str) -> u8 {
    use twox_hash::XxHash64;
    use std::hash::{Hash, Hasher};
    let mut h = XxHash64::with_seed(0);
    (user_key, "::", experiment).hash(&mut h);
    (h.finish() % 100) as u8
}
```

示例：`tower::Layer` 注入决策到 `RequestExtensions`

```rust
pub struct RoutingDecision { pub variant: &'static str }

pub struct RoutingLayer;

impl<S> tower::Layer<S> for RoutingLayer {
    type Service = RoutingService<S>;
    fn layer(&self, inner: S) -> Self::Service { RoutingService { inner } }
}

pub struct RoutingService<S> { inner: S }

impl<S, Req> tower::Service<Req> for RoutingService<S>
where
    S: tower::Service<Req>,
    Req: http::RequestExt + Send + 'static,
{
    type Response = S::Response;
    type Error = S::Error;
    type Future = S::Future;
    fn poll_ready(&mut self, cx: &mut std::task::Context<'_>) -> std::task::Poll<Result<(), Self::Error>> {
        self.inner.poll_ready(cx)
    }
    fn call(&mut self, mut req: Req) -> Self::Future {
        let bucket = pick_bucket("uid123", "exp-abc");
        let decision = if bucket < 30 { "canary" } else { "stable" };
        req.extensions_mut().insert(RoutingDecision { variant: decision });
        self.inner.call(req)
    }
}
```

> 在业务处理器中从 `Extensions` 读取 `RoutingDecision`，即可选择不同实现或下游目标（如 `v1` 与 `v2` 客户端）。

## 5.4.6 最佳实践清单

- 明确优先级：网关策略 > 服务内策略 > 客户端提示，避免“决策抖动”。
- 决策可追踪：记录决策输入/输出，保障审计与回放；线上回放需屏蔽敏感字段。
- 可灰度可回退：每次变更具备“撤回/全量推进”开关，配合保护阈值。
- 与 AB 实验平台对齐：共享用户分桶算法，避免跨系统跑偏。
- 配置热更新与降级：远端不可用时保留最后一次成功配置，超时降级至稳定路径。
- 多云多区域一致性：依赖 `trace id` 或用户粘滞，避免跨区跳转导致状态不一致。
