# 11.1 性能基准测试

## 11.1.1 微基准（Criterion）

- 使用 `criterion` 进行函数级基准，固定输入、隔离 IO；
- 统计 P50/P95/P99 与置信区间；
- 绑定 CI 阈值，回归即失败。

## 11.1.2 端到端压测

- HTTP：wrk/hey/k6；gRPC：ghz；
- 分层：网关 → 服务 → 存储；
- 基线/峰值/容量曲线，记录扩缩容点。

## 11.1.3 与 benches/ 与脚本联动

- 目录：`benches/axum_benchmark.rs`、`benches/grpc_benchmark.rs`、`benches/messaging_benchmark.rs`、`benches/comprehensive_benchmark.rs`；
- 运行脚本：`scripts/run_benchmarks.(ps1|sh)`，生成对比报告与趋势；
- 校验脚本：`scripts/verify_docs.(ps1|sh)`、`scripts/verify_advancement.(ps1|sh)`；
- 结合 CI：基准回归门禁（P95/P99 超过阈值即失败）。

### 示例：本地运行

```bash
cargo bench --bench axum_benchmark
cargo bench --bench grpc_benchmark
```

### 示例：端到端压测（HTTP 与 gRPC）

```bash
# HTTP（hey）
hey -z 60s -q 100 -c 200 https://localhost/api/users/1

# gRPC（ghz）
ghz --insecure --call user.UserService/GetUser -d '{"id":1}' 0.0.0.0:50051 -z 60s -c 200 -x 100
```

### 指标采集与看板

- 应用导出：`/metrics`（Prometheus）；追踪：OTel（见根文档）；
- 看板：延迟分布/错误率/QPS/CPU/内存；
- Exemplars：将 P99 样本关联具体 Trace，快速定位瓶颈（见 OTel 指南）。
