# æ··æ²Œå·¥ç¨‹ Playbook ä¸æ•…éšœæ¼”ç»ƒ

> åŸºäºRust 1.90å’Œ2025å¹´æœ€æ–°æŠ€æœ¯æ ˆçš„æ··æ²Œå·¥ç¨‹å®Œæ•´å®è·µæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†æ··æ²Œå·¥ç¨‹çš„å®Œæ•´å®è·µæŒ‡å—ï¼ŒåŒ…æ‹¬æ•…éšœæ³¨å…¥åœºæ™¯ã€æ¼”ç»ƒæµç¨‹ã€ç›‘æ§æŒ‡æ ‡å’Œæ¢å¤ç­–ç•¥ï¼Œå¸®åŠ©å›¢é˜Ÿå»ºç«‹å¯é çš„å¾®æœåŠ¡ç³»ç»Ÿã€‚

## ğŸ¯ æ··æ²Œå·¥ç¨‹ç›®æ ‡

### 1. æ ¸å¿ƒç›®æ ‡

- âœ… **æå‡ç³»ç»ŸéŸ§æ€§**ï¼šé€šè¿‡æ•…éšœæ³¨å…¥å‘ç°ç³»ç»Ÿå¼±ç‚¹
- âœ… **éªŒè¯æ¢å¤èƒ½åŠ›**ï¼šç¡®ä¿æ•…éšœæ¢å¤æœºåˆ¶æœ‰æ•ˆ
- âœ… **å»ºç«‹ä¿¡å¿ƒ**ï¼šå›¢é˜Ÿå¯¹ç³»ç»Ÿå¯é æ€§æœ‰ä¿¡å¿ƒ
- âœ… **æŒç»­æ”¹è¿›**ï¼šåŸºäºæ¼”ç»ƒç»“æœæŒç»­ä¼˜åŒ–ç³»ç»Ÿ

### 2. æˆåŠŸæŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|--------|----------|
| æ•…éšœæ£€æµ‹æ—¶é—´ | < 1åˆ†é’Ÿ | ç›‘æ§å‘Šè­¦ |
| æ•…éšœæ¢å¤æ—¶é—´ | < 5åˆ†é’Ÿ | è‡ªåŠ¨åŒ–æ¢å¤ |
| æ•°æ®ä¸¢å¤±ç‡ | 0% | æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ |
| æœåŠ¡å¯ç”¨æ€§ | > 99.9% | ç›‘æ§ç³»ç»Ÿ |
| å›¢é˜Ÿå“åº”æ—¶é—´ | < 2åˆ†é’Ÿ | æ¼”ç»ƒè®°å½• |

## ğŸ”§ æ•…éšœæ³¨å…¥åœºæ™¯åº“

### 1. åŸºç¡€è®¾æ–½æ•…éšœ

#### 1.1 ç½‘ç»œæ•…éšœ

```yaml
# chaos-mesh/network-chaos.yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: NetworkChaos
metadata:
  name: network-delay
  namespace: microservice
spec:
  action: delay
  mode: one
  selector:
    namespaces:
      - microservice
    labelSelectors:
      app: microservice
  delay:
    latency: 100ms
    correlation: 100
    jitter: 10ms
  duration: 300s
```

#### 1.2 èŠ‚ç‚¹æ•…éšœ

```yaml
# chaos-mesh/node-chaos.yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: NodeChaos
metadata:
  name: node-failure
  namespace: microservice
spec:
  action: node-failure
  mode: one
  selector:
    namespaces:
      - microservice
  duration: 60s
```

#### 1.3 ç£ç›˜æ•…éšœ

```yaml
# chaos-mesh/io-chaos.yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: IOChaos
metadata:
  name: disk-latency
  namespace: microservice
spec:
  action: latency
  mode: one
  selector:
    namespaces:
      - microservice
  volumePath: /var/lib/data
  path: /var/lib/data/test
  delay: 100ms
  percent: 50
  duration: 300s
```

### 2. åº”ç”¨å±‚æ•…éšœ

#### 2.1 æœåŠ¡æ•…éšœ

```rust
// chaos-engineering/service-chaos.rs
use std::time::Duration;
use tokio::time::sleep;
use rand::Rng;

pub struct ServiceChaos {
    failure_rate: f64,
    latency_range: (u64, u64),
    error_types: Vec<String>,
}

impl ServiceChaos {
    pub fn new(failure_rate: f64, latency_range: (u64, u64)) -> Self {
        Self {
            failure_rate,
            latency_range,
            error_types: vec![
                "timeout".to_string(),
                "connection_refused".to_string(),
                "internal_error".to_string(),
            ],
        }
    }
    
    pub async fn inject_failure(&self) -> Result<(), Box<dyn std::error::Error>> {
        let mut rng = rand::thread_rng();
        
        // éšæœºå»¶è¿Ÿ
        let delay = rng.gen_range(self.latency_range.0..=self.latency_range.1);
        sleep(Duration::from_millis(delay)).await;
        
        // éšæœºæ•…éšœ
        if rng.gen::<f64>() < self.failure_rate {
            let error_type = &self.error_types[rng.gen_range(0..self.error_types.len())];
            return Err(format!("Chaos injection: {}", error_type).into());
        }
        
        Ok(())
    }
}

// åœ¨æœåŠ¡ä¸­ä½¿ç”¨
pub async fn handle_request(&self, request: Request) -> Result<Response, Error> {
    // æ³¨å…¥æ•…éšœ
    self.chaos.inject_failure().await?;
    
    // æ­£å¸¸ä¸šåŠ¡é€»è¾‘
    self.process_request(request).await
}
```

#### 2.2 æ•°æ®åº“æ•…éšœ

```rust
// chaos-engineering/database-chaos.rs
use sqlx::{PgPool, Error as SqlxError};
use std::time::Duration;
use tokio::time::sleep;

pub struct DatabaseChaos {
    pool: PgPool,
    failure_rate: f64,
    timeout_duration: Duration,
}

impl DatabaseChaos {
    pub fn new(pool: PgPool, failure_rate: f64) -> Self {
        Self {
            pool,
            failure_rate,
            timeout_duration: Duration::from_secs(30),
        }
    }
    
    pub async fn inject_connection_failure(&self) -> Result<(), SqlxError> {
        let mut rng = rand::thread_rng();
        
        if rng.gen::<f64>() < self.failure_rate {
            // æ¨¡æ‹Ÿè¿æ¥è¶…æ—¶
            sleep(self.timeout_duration).await;
            return Err(SqlxError::PoolTimedOut);
        }
        
        Ok(())
    }
    
    pub async fn inject_query_failure(&self) -> Result<(), SqlxError> {
        let mut rng = rand::thread_rng();
        
        if rng.gen::<f64>() < self.failure_rate {
            // æ¨¡æ‹ŸæŸ¥è¯¢å¤±è´¥
            return Err(SqlxError::RowNotFound);
        }
        
        Ok(())
    }
}
```

### 3. ä¾èµ–æœåŠ¡æ•…éšœ

#### 3.1 å¤–éƒ¨APIæ•…éšœ

```rust
// chaos-engineering/external-api-chaos.rs
use reqwest::Client;
use std::time::Duration;
use tokio::time::timeout;

pub struct ExternalApiChaos {
    client: Client,
    failure_rate: f64,
    timeout_duration: Duration,
}

impl ExternalApiChaos {
    pub async fn call_external_api(&self, url: &str) -> Result<String, Box<dyn std::error::Error>> {
        let mut rng = rand::thread_rng();
        
        // éšæœºæ•…éšœæ³¨å…¥
        if rng.gen::<f64>() < self.failure_rate {
            // æ¨¡æ‹Ÿè¶…æ—¶
            timeout(self.timeout_duration, async {
                sleep(Duration::from_secs(60)).await;
                Ok("timeout".to_string())
            }).await??;
        }
        
        // æ­£å¸¸APIè°ƒç”¨
        let response = self.client.get(url).send().await?;
        let body = response.text().await?;
        Ok(body)
    }
}
```

## ğŸ“Š ç›‘æ§ä¸å‘Šè­¦

### 1. å…³é”®æŒ‡æ ‡ç›‘æ§

```rust
// monitoring/chaos-metrics.rs
use prometheus::{Counter, Histogram, Gauge, Registry};
use std::sync::Arc;

pub struct ChaosMetrics {
    pub chaos_injections_total: Counter,
    pub chaos_duration_seconds: Histogram,
    pub service_availability: Gauge,
    pub error_rate: Gauge,
    pub recovery_time_seconds: Histogram,
}

impl ChaosMetrics {
    pub fn new(registry: &Registry) -> Self {
        let chaos_injections_total = Counter::new(
            "chaos_injections_total",
            "Total number of chaos injections"
        ).unwrap();
        
        let chaos_duration_seconds = Histogram::new(
            "chaos_duration_seconds",
            "Duration of chaos injections"
        ).unwrap();
        
        let service_availability = Gauge::new(
            "service_availability",
            "Service availability percentage"
        ).unwrap();
        
        let error_rate = Gauge::new(
            "error_rate",
            "Error rate percentage"
        ).unwrap();
        
        let recovery_time_seconds = Histogram::new(
            "recovery_time_seconds",
            "Time to recover from failures"
        ).unwrap();
        
        registry.register(Box::new(chaos_injections_total.clone())).unwrap();
        registry.register(Box::new(chaos_duration_seconds.clone())).unwrap();
        registry.register(Box::new(service_availability.clone())).unwrap();
        registry.register(Box::new(error_rate.clone())).unwrap();
        registry.register(Box::new(recovery_time_seconds.clone())).unwrap();
        
        Self {
            chaos_injections_total,
            chaos_duration_seconds,
            service_availability,
            error_rate,
            recovery_time_seconds,
        }
    }
}
```

### 2. å‘Šè­¦è§„åˆ™

```yaml
# prometheus/chaos-alerts.yml
groups:
  - name: chaos-engineering
    rules:
      - alert: HighErrorRateDuringChaos
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected during chaos injection"
          
      - alert: ServiceUnavailable
        expr: up{job="microservice"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service is unavailable"
          
      - alert: LongRecoveryTime
        expr: histogram_quantile(0.95, recovery_time_seconds) > 300
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Recovery time is too long"
          
      - alert: DataInconsistency
        expr: data_consistency_check_failures_total > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Data inconsistency detected"
```

## ğŸš€ æ¼”ç»ƒæµç¨‹

### 1. æ¼”ç»ƒå‰å‡†å¤‡

```bash
#!/bin/bash
# scripts/chaos-engineering-prep.sh

echo "ğŸ”§ å‡†å¤‡æ··æ²Œå·¥ç¨‹æ¼”ç»ƒ..."

# 1. æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
echo "æ£€æŸ¥ç³»ç»ŸçŠ¶æ€..."
kubectl get pods -n microservice
kubectl get services -n microservice

# 2. å¤‡ä»½é‡è¦æ•°æ®
echo "å¤‡ä»½é‡è¦æ•°æ®..."
kubectl exec -n microservice deployment/postgres -- pg_dump -U postgres microservice > backup_$(date +%Y%m%d_%H%M%S).sql

# 3. æ£€æŸ¥ç›‘æ§ç³»ç»Ÿ
echo "æ£€æŸ¥ç›‘æ§ç³»ç»Ÿ..."
curl -f http://prometheus:9090/api/v1/query?query=up
curl -f http://grafana:3000/api/health

# 4. é€šçŸ¥å›¢é˜Ÿ
echo "é€šçŸ¥å›¢é˜Ÿ..."
curl -X POST -H 'Content-type: application/json' \
  --data '{"text":"æ··æ²Œå·¥ç¨‹æ¼”ç»ƒå³å°†å¼€å§‹ï¼Œè¯·åšå¥½å‡†å¤‡"}' \
  $SLACK_WEBHOOK_URL

echo "âœ… æ¼”ç»ƒå‡†å¤‡å®Œæˆ"
```

### 2. æ¼”ç»ƒæ‰§è¡Œ

```bash
#!/bin/bash
# scripts/chaos-engineering-execute.sh

set -e

echo "ğŸ¯ å¼€å§‹æ··æ²Œå·¥ç¨‹æ¼”ç»ƒ..."

# 1. ç½‘ç»œå»¶è¿Ÿæ³¨å…¥
echo "æ³¨å…¥ç½‘ç»œå»¶è¿Ÿ..."
kubectl apply -f chaos-mesh/network-chaos.yaml

# ç­‰å¾…å¹¶ç›‘æ§
sleep 60
echo "ç›‘æ§ç½‘ç»œå»¶è¿Ÿå½±å“..."
kubectl get networkchaos -n microservice

# 2. æœåŠ¡æ•…éšœæ³¨å…¥
echo "æ³¨å…¥æœåŠ¡æ•…éšœ..."
kubectl apply -f chaos-mesh/pod-chaos.yaml

# ç­‰å¾…å¹¶ç›‘æ§
sleep 60
echo "ç›‘æ§æœåŠ¡æ•…éšœå½±å“..."
kubectl get podchaos -n microservice

# 3. æ•°æ®åº“æ•…éšœæ³¨å…¥
echo "æ³¨å…¥æ•°æ®åº“æ•…éšœ..."
kubectl apply -f chaos-mesh/io-chaos.yaml

# ç­‰å¾…å¹¶ç›‘æ§
sleep 60
echo "ç›‘æ§æ•°æ®åº“æ•…éšœå½±å“..."
kubectl get iochaos -n microservice

# 4. æ¸…ç†æ•…éšœæ³¨å…¥
echo "æ¸…ç†æ•…éšœæ³¨å…¥..."
kubectl delete -f chaos-mesh/network-chaos.yaml
kubectl delete -f chaos-mesh/pod-chaos.yaml
kubectl delete -f chaos-mesh/io-chaos.yaml

echo "âœ… æ¼”ç»ƒæ‰§è¡Œå®Œæˆ"
```

### 3. æ¼”ç»ƒååˆ†æ

```bash
#!/bin/bash
# scripts/chaos-engineering-analysis.sh

echo "ğŸ“Š åˆ†ææ¼”ç»ƒç»“æœ..."

# 1. æ”¶é›†æŒ‡æ ‡æ•°æ®
echo "æ”¶é›†æŒ‡æ ‡æ•°æ®..."
curl -s "http://prometheus:9090/api/v1/query_range?query=rate(http_requests_total[5m])&start=$(date -d '1 hour ago' +%s)&end=$(date +%s)&step=60" > metrics_data.json

# 2. ç”ŸæˆæŠ¥å‘Š
echo "ç”Ÿæˆæ¼”ç»ƒæŠ¥å‘Š..."
python3 scripts/generate_chaos_report.py metrics_data.json

# 3. æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
echo "æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§..."
kubectl exec -n microservice deployment/postgres -- psql -U postgres -d microservice -c "SELECT COUNT(*) FROM orders;"

# 4. å‘é€æŠ¥å‘Š
echo "å‘é€æ¼”ç»ƒæŠ¥å‘Š..."
curl -X POST -H 'Content-type: application/json' \
  --data @chaos_report.json \
  $SLACK_WEBHOOK_URL

echo "âœ… æ¼”ç»ƒåˆ†æå®Œæˆ"
```

## ğŸ”„ è‡ªåŠ¨åŒ–æ¼”ç»ƒ

### 1. å®šæ—¶æ¼”ç»ƒ

```yaml
# k8s/chaos-engineering-cronjob.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: chaos-engineering-cronjob
  namespace: microservice
spec:
  schedule: "0 2 * * 1"  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹æ‰§è¡Œ
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: chaos-engineering
            image: chaos-engineering:latest
            command:
            - /bin/bash
            - -c
            - |
              echo "å¼€å§‹å®šæ—¶æ··æ²Œå·¥ç¨‹æ¼”ç»ƒ..."
              ./scripts/chaos-engineering-prep.sh
              ./scripts/chaos-engineering-execute.sh
              ./scripts/chaos-engineering-analysis.sh
              echo "å®šæ—¶æ¼”ç»ƒå®Œæˆ"
            env:
            - name: SLACK_WEBHOOK_URL
              valueFrom:
                secretKeyRef:
                  name: slack-webhook
                  key: url
          restartPolicy: OnFailure
```

### 2. æŒç»­é›†æˆé›†æˆ

```yaml
# .github/workflows/chaos-engineering.yml
name: Chaos Engineering

on:
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹
  workflow_dispatch:

jobs:
  chaos-engineering:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: Setup Chaos Mesh
        run: |
          curl -sSL https://mirrors.chaos-mesh.org/v2.6.0/install.sh | bash
      
      - name: Run Chaos Engineering
        run: |
          ./scripts/chaos-engineering-prep.sh
          ./scripts/chaos-engineering-execute.sh
          ./scripts/chaos-engineering-analysis.sh
      
      - name: Upload Results
        uses: actions/upload-artifact@v3
        with:
          name: chaos-engineering-results
          path: chaos_report.json
```

## ğŸ“š æœ€ä½³å®è·µ

### 1. æ¼”ç»ƒè®¾è®¡åŸåˆ™

- âœ… **æ¸è¿›å¼æ¼”ç»ƒ**ï¼šä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥å¢åŠ éš¾åº¦
- âœ… **ä¸šåŠ¡æ—¶é—´**ï¼šåœ¨ä¸šåŠ¡ä½å³°æœŸè¿›è¡Œæ¼”ç»ƒ
- âœ… **å›¢é˜Ÿå‚ä¸**ï¼šç¡®ä¿ç›¸å…³å›¢é˜Ÿå‚ä¸æ¼”ç»ƒ
- âœ… **æ–‡æ¡£è®°å½•**ï¼šè¯¦ç»†è®°å½•æ¼”ç»ƒè¿‡ç¨‹å’Œç»“æœ

### 2. æ•…éšœæ³¨å…¥åŸåˆ™

- âœ… **å¯æ§æ€§**ï¼šç¡®ä¿æ•…éšœæ³¨å…¥å¯ä»¥æ§åˆ¶å’Œåœæ­¢
- âœ… **å¯è§‚æµ‹æ€§**ï¼šå……åˆ†ç›‘æ§æ•…éšœæ³¨å…¥çš„å½±å“
- âœ… **å¯æ¢å¤æ€§**ï¼šç¡®ä¿ç³»ç»Ÿå¯ä»¥å¿«é€Ÿæ¢å¤
- âœ… **å¯é‡å¤æ€§**ï¼šæ¼”ç»ƒç»“æœå¯ä»¥é‡å¤éªŒè¯

### 3. å›¢é˜Ÿåä½œ

- âœ… **æ˜ç¡®è§’è‰²**ï¼šæ˜ç¡®æ¯ä¸ªå›¢é˜Ÿæˆå‘˜çš„è§’è‰²å’ŒèŒè´£
- âœ… **æ²Ÿé€šæœºåˆ¶**ï¼šå»ºç«‹æœ‰æ•ˆçš„æ²Ÿé€šæœºåˆ¶
- âœ… **åº”æ€¥é¢„æ¡ˆ**ï¼šåˆ¶å®šè¯¦ç»†çš„åº”æ€¥é¢„æ¡ˆ
- âœ… **æŒç»­æ”¹è¿›**ï¼šåŸºäºæ¼”ç»ƒç»“æœæŒç»­æ”¹è¿›

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å¾®æœåŠ¡æµ‹è¯•ç­–ç•¥ä¸æ··æ²Œå·¥ç¨‹](./25.1_å¾®æœåŠ¡æµ‹è¯•ç­–ç•¥ä¸æ··æ²Œå·¥ç¨‹.md)
- [é”™è¯¯å¤„ç†ä¸å®¹é”™æœºåˆ¶](./12_æœ€ä½³å®è·µä¸æ¡ˆä¾‹ç ”ç©¶/12.2_é”™è¯¯å¤„ç†ä¸å®¹é”™æœºåˆ¶.md)
- [ç›‘æ§ä¸å‘Šè­¦ç³»ç»Ÿ](./24_é«˜çº§ç›‘æ§ä¸å‘Šè­¦/24.1_åˆ†å¸ƒå¼è¿½è¸ªä¸å‘Šè­¦ç³»ç»Ÿ.md)
- [æ€§èƒ½åŸºå‡†æµ‹è¯•](./11_æ€§èƒ½ä¼˜åŒ–ä¸æµ‹è¯•/11.1_æ€§èƒ½åŸºå‡†æµ‹è¯•.md)

## ğŸ“ æ›´æ–°æ—¥å¿—

- **2025-01-XX**: åˆå§‹ç‰ˆæœ¬åˆ›å»º
- **2025-01-XX**: æ·»åŠ Rust 1.90æœ€æ–°å®è·µ
- **2025-01-XX**: å®Œå–„æ•…éšœæ³¨å…¥åœºæ™¯
- **2025-01-XX**: å¢åŠ è‡ªåŠ¨åŒ–æ¼”ç»ƒæµç¨‹

---

**æ³¨æ„**ï¼šæœ¬æ–‡æ¡£åŸºäºRust 1.90å’Œ2025å¹´æœ€æ–°æŠ€æœ¯æ ˆï¼Œå»ºè®®å®šæœŸæ›´æ–°ä»¥ä¿æŒæ—¶æ•ˆæ€§ã€‚
