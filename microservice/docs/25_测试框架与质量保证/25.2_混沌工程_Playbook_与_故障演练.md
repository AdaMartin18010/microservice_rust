# 25.2 混沌工程 Playbook 与 故障演练

> 建立场景库、注入点与期望观测，形成可复用的演练手册。

## 25.2.1 场景库（节选）

- 网络：延迟/丢包/抖动/断链
- 资源：CPU/内存/磁盘/句柄耗尽
- 依赖：下游超时/500/半开
- 消息：Kafka 积压/NATS 丢失/重复投递
- 存储：主从切换/慢查询/连接池耗尽
- 配置：错误配置/灰度错误/特性开关误用
- 部署：滚动发布失败/回滚失败/Pod 抖动
- 区域：AZ 宕机/跨区网络分区/多活切流

## 25.2.2 注入与回收

- K8s 层：`chaos-mesh`/`litmus` 注入；演练结束回收
- 应用层：故障开关（NATS KV/Consul KV）与灰度影响域
- 基础设施层：负载均衡权重调整/防火墙规则/网关熔断
- 回收原则：幂等可逆、最短路径、自动化优先（`kubectl delete`/`helm rollback`/`chaosctl recover`）

## 25.2.3 观测期望与判定

- 指标：错误率/延迟/QPS/饱和度（RED+USE 方法）
- 追踪：关键链路 span 可见且带 `x-request-id`
- 日志：异常具上下文（租户/用户/订单）并可按 `trace_id` 关联
- 事件：告警被触发/抑制规则生效/工单自动创建

## 25.2.4 SLO 回归

- 设定前置 SLO，演练后对比回归
- 未达标触发变更项（限流、重试、隔离、降级、缓存）
- 以“业务可用性”与“关键链路 p99 延迟”作为第一判据

## 25.2.5 常见反模式

- 仅做演示不闭环（无整改项/无回归）
- 注入强度过大导致不可控（越级到生产级灾难）
- 未纳入回滚与应急流程（缺少 Stop 按钮）
- 无最小影响域与灰度策略（全量注入）
- 无法重复（手工多、环境差异大）

## 25.2.6 执行流程与角色分工

- 计划（Plan）：收集风险、确定目标、选场景、定义退出条件（Owner：SRE）
- 准备（Prepare）：基线快照、数据脱敏、回滚剧本、演练窗口审批（Owner：变更经理）
- 执行（Execute）：按步骤注入、留存证据、实时观测（Owner：演练指挥）
- 判定（Evaluate）：对照 SLO、生成差距清单、提出整改（Owner：架构/后端负责人）
- 回收（Recover）：撤销注入、恢复流量、校验业务健康（Owner：SRE）
- 复盘（Review）：RCA、CAPA、变更到“端到端生产基线”（Owner：全体）

时间线（建议）：

- D-3：审批通过、基线对齐、观测校验
- D-1：沙箱预演、自动化脚本自测、回滚验收
- D 日：正式演练、实时播报、关键指标看板
- D+1：复盘会议、整改项排期与跟踪

## 25.2.7 注入样例（Chaos Mesh）

- 网络延迟 200ms 注入（命名空间级，选择器按标签）：

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: NetworkChaos
metadata:
  name: payment-network-latency
  namespace: micro
spec:
  action: delay
  mode: one
  selector:
    namespaces:
      - micro
    labelSelectors:
      app: payment
  delay:
    latency: "200ms"
    correlation: "25"
    jitter: "50ms"
  duration: "10m"
  direction: to
  target:
    selector:
      labelSelectors:
        app: order
    mode: all
```

- Pod CPU 压榨（容器级）：

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: StressChaos
metadata:
  name: order-cpu-stress
  namespace: micro
spec:
  mode: fixed
  value: '2'
  selector:
    labelSelectors:
      app: order
  stressors:
    cpu:
      workers: 2
      load: 75
  duration: "5m"
```

- DNS 故障（模拟依赖解析失败）：

```yaml
apiVersion: chaos-mesh.org/v1alpha1
kind: DNSChaos
metadata:
  name: block-external-api
  namespace: micro
spec:
  action: error
  patterns:
    - "api.external.com"
  duration: "15m"
```

## 25.2.8 应用级故障开关（Rust 示例）

- 通过 NATS KV 配置开关，灰度生效域：

```rust
// 伪代码示例：读取 KV 决策是否注入错误
async fn should_inject_error(account_id: &str, nats: &NatsKv) -> bool {
    let key = format!("chaos:payment:error:{}", account_id);
    if let Some(v) = nats.get(&key).await.ok().flatten() {
        return v == "1";
    }
    nats.get("chaos:payment:error:global").await.ok().flatten() == Some("1".into())
}
```

- 在 handler 中按灰度故障开关返回错误或延迟：

```rust
// 伪代码示例：按开关注入延迟/错误
pub async fn pay_handler(req: Request, deps: Deps) -> Result<Response, Error> {
    if should_inject_error(req.account_id(), &deps.nats_kv).await {
        tokio::time::sleep(Duration::from_millis(250)).await;
        return Err(Error::temporary("chaos_injected"));
    }
    // 正常逻辑
    process_payment(req, deps).await
}
```

## 25.2.9 自动化与集成

- Pipeline 集成：
  - 准入：部署后在 `stage: chaos-precheck` 校验观测与回滚剧本
  - 执行：`stage: chaos-run` 触发注入，产出 `junit.xml`/`tracing.json`/`metrics.csv`
  - 准出：SLO 差异 < 阈值方可进入生产门禁
- 可观测性集成：
  - 指标：PromQL 用例，与演练 id 绑定 label `experiment_id`
  - 追踪：propagate `x-request-id`，按 `experiment_id` 过滤 span
  - 日志：结构化字段 `tenant_id`,`experiment_id`,`trace_id`

示例（GitHub Actions 片段）：

```yaml
jobs:
  chaos:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install chaosctl
        run: |
          curl -L https://example/chaosctl.sh | bash
      - name: Run chaos experiment
        run: |
          chaosctl apply -f k8s/chaos/payment-network-latency.yaml --experiment-id $GITHUB_RUN_ID
      - name: Verify SLO
        run: |
          ./scripts/verify_slo.sh --exp $GITHUB_RUN_ID --budget 0.5
```

## 25.2.10 回滚与应急按钮

- 必备：
  - 单命令回收注入：`chaosctl recover --all --namespace micro`
  - 单命令回滚版本：`helm rollback payment 0`
  - 单命令切流：`kubectl -n istio-system apply -f dr-failover.yaml`
- 演练中止条件：连续 3 分钟 p99 > 阈值、失败率 > 2x 正常、关键告警触发
- 责任：演练指挥拥有最终“Stop”权限

## 25.2.11 报告模板（摘录）

- 元信息：实验编号/系统/时间窗口/审批单/指挥与执行
- 场景与注入：清单、强度、影响域、退出条件
- 观测与结果：关键指标对照（前/中/后）、告警与追踪截图
- 判定与结论：是否达标、偏差来源、RCA 摘要
- 整改与跟踪：措施、Owner、目标日期、复验计划

## 25.2.12 检查清单（Checklist）

- 执行前：
  - [ ] SLO/SLA/告警基线存在且已验证
  - [ ] 回滚/切流剧本演练通过
  - [ ] 影响域与强度经过审批
  - [ ] 实验 id、标签、关联看板就绪
- 执行中：
  - [ ] 实时看板与告警无盲点
  - [ ] 证据留存（日志/追踪/指标导出）
  - [ ] 中止条件明确并可执行
- 执行后：
  - [ ] 注入回收与健康验证完成
  - [ ] 报告归档与整改项立项
  - [ ] SLO 回归通过或进入门禁豁免流程

## 25.2.13 关联阅读

- `11.x` 性能与压测
- `8.x` 可观测性
- `14.12` 端到端生产基线·落地索引
- `12.2` 错误处理与容错机制

---
最后更新：2025-09-25
