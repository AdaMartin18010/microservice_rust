# 原生 async trait 迁移策略与边界（Rust 1.90 / edition=2024）

## 何时使用原生 async trait

- 内部接口、无需 `dyn Trait` 对象安全的场景。
- 仅在本 crate 或受控边界内使用、易于统一升级的模块。
- 追求更简洁的签名与更少依赖（移除 `async-trait` 宏）。

## 何时保留 `#[async_trait]`

- 需要以 `Box<dyn Trait>`/`Arc<dyn Trait>` 暴露并跨边界传递的接口（对象安全要求）。
- 生态或框架约束暂时要求 `dyn` 的位置（如可插拔插件、注册中心存储 `dyn Trait`）。

## 公开 trait 的推荐写法

- 避免公开 trait 使用 `async fn` 直接暴露返回 `Future` 的自动 trait 边界问题。
- 推荐：使用返回 `-> impl Future<...> + Send` 的同步方法签名。

示例：

```rust
pub trait UserOps {
    fn get_user(&self, id: String) -> impl Future<Output = Result<User>> + Send;
}
```

## 双轨迁移（兼容演进）

- 为既有 `#[async_trait]` 接口保留旧路径；新增并行的 `Native*` 接口。
- 新代码优先依赖原生接口；旧路径渐进迁移，最后统一收敛。

## 边界与注意事项

- 对象安全：原生 `async fn` 的 trait 目前仍受对象安全限制，不适合直接用于 `dyn`。
- API 稳定性：公开 API 采用 `-> impl Future + Send` 后，注意未来放宽边界将是破坏性变更。
- 一致性：同一模块内保持统一风格，避免混杂导致可读性下降。

## 性能与可读性

- 原生 async 避免宏展开与额外装箱，签名更直观。
- 在热点路径配合 `-> impl Future` 可减少不必要的 `Pin<Box<...>>`。

## 迁移步骤（建议）

1. 标注需要 `dyn` 的接口，明确保留 `#[async_trait]` 清单。
2. 为内部接口新增 `Native*` trait，采用 `-> impl Future + Send`。
3. 渐进替换调用点，保证每步 `cargo check --workspace --all-targets` 通过。
4. 调整示例与文档，沉淀最佳实践与边界解释。
5. 收敛阶段再评估是否完全移除 `#[async_trait]`。

## 验证清单（与 CI 集成）

- 构建：`cargo check --workspace --all-targets`。
- Lints（受限特性集）：`cargo clippy --no-default-features`（Windows 下避免 OpenSSL 构建）。
- 示例：关键 examples 运行/检查，覆盖原生接口与 `dyn` 场景。

## 本项目现状

- 已在示例与 `src/rust_190_optimized.rs` 引入原生化改造；
- 继续保留框架统一接口与注册/编排中需要 `dyn` 的位置；
- 文档与示例同步更新，提供可复用的迁移模式。
