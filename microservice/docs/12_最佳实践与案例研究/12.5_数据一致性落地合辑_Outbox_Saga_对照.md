# 12.5 数据一致性落地合辑：Outbox / Saga / 事件回放（Rust 1.90）

> 汇总 12.3 策略、7.x 事件驱动、11.5 形式化验证切入点，提供可执行的选型矩阵与对照表。

## 12.5.1 选型矩阵（节选）

- 单体数据库 + 事务边界清晰：优先本地事务 + Outbox
- 跨服务多步操作：优先 Saga（编排/编舞）
- 高可靠审计与回放：事件溯源（需补充快照/压缩）

## 12.5.2 Outbox 模式（基线）

- 写 DB 与写 Outbox 同事务提交
- 后台 Outbox Relay 异步发布至 Kafka
- 去重键：`aggregate_id + version`，幂等消费

```sql
-- Outbox 表结构（示例）
CREATE TABLE outbox (
  id BIGSERIAL PRIMARY KEY,
  aggregate_id TEXT NOT NULL,
  version BIGINT NOT NULL,
  event_type TEXT NOT NULL,
  payload JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (aggregate_id, version)
);
```

## 12.5.3 Saga 模式（基线）

- 编排型：集中状态机；编舞型：去中心化事件驱动
- 补偿动作与时序图明确；死信/超时策略就绪

## 12.5.4 事件回放与补偿

- Kafka 分区重放 + 并发度限制
- 影子读校验 + 幂等写

## 12.5.5 TLA+ 验证切入点

- 关键不变式：余额不为负、订单状态单调、Exactly-once 语义
- 参考 `formal/` 中 TLA+ 模型，增加补偿步骤与重试路径

## 12.5.6 关联阅读

- `12.3` 数据一致性策略
- `7.x` 事件驱动架构与 NATS/Kafka 组合
- `11.5` 形式化验证 TLA+ 入门
- `14.12` 端到端生产基线·落地索引

---
最后更新：2025-09-25
